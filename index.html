<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.4.0" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.4.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.4.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '6.4.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="✨✨✨">
<meta property="og:type" content="website">
<meta property="og:title" content="Afterwork">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="Afterwork">
<meta property="og:description" content="✨✨✨">
<meta property="og:locale" content="default">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Afterwork">
<meta name="twitter:description" content="✨✨✨">






  <link rel="canonical" href="http://yoursite.com/"/>



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Afterwork</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="default">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Afterwork</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Life is too short to think small.</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">
    <a href="/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-home"></i> <br />Home</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-about">
    <a href="/about/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-user"></i> <br />About</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">
    <a href="/tags/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />Tags</a>
  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">
    <a href="/archives/" rel="section">
      <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />Archives</a>
  </li>

      
      
    </ul>
  

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/16/threadnaming/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/16/threadnaming/" itemprop="url">
                  💻 Naming Threads in C++
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-12-16 15:27:29 / Modified: 16:22:15" itemprop="dateCreated datePublished" datetime="2020-12-16T15:27:29-08:00">2020-12-16</time>
            

            
              

              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>It’s always much more convenient to know the thread name than just the thread id, when debugging an application with multiple threads. This post introduces how to set thread names properly in different platforms.</p>
<h1 id="Linux"><a href="#Linux" class="headerlink" title="Linux"></a>Linux</h1><p>Use <a href="https://man7.org/linux/man-pages/man3/pthread_setname_np.3.html" target="_blank" rel="noopener">pthread</a> to name threads:</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line">pthread_setname_np(pthread_self(), name)</span><br><span class="line">pthread_setname_np(thread.native_handle(), name)</span><br></pre></td></tr></table></figure>
<p>Note: Thread name length is restricted to 16 characters.</p>
<p>Then you can check thread names by following commands:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/pid/task/[tid]/comm</span><br><span class="line">ps ps -eL -o lwp,comm | grep tid</span><br></pre></td></tr></table></figure>
<h1 id="Mac"><a href="#Mac" class="headerlink" title="Mac"></a>Mac</h1><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line">pthread_setname_np(name)</span><br></pre></td></tr></table></figure>
<h1 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h1><h2 id="Set-Thread-Name-in-Native-Code"><a href="#Set-Thread-Name-in-Native-Code" class="headerlink" title="Set Thread Name in Native Code"></a><a href="https://docs.microsoft.com/en-us/visualstudio/debugger/how-to-set-a-thread-name-in-native-code?view=vs-2019" target="_blank" rel="noopener">Set Thread Name in Native Code</a></h2><p>The native method of setting the thread name is implemented by raising an SEH exception that is continued. An attached native debugger will get a ‘first chance’ notification of the exception. Raising an exception is precisely what you need to do to get the native debugger’s attention. The one raised here (0x406D1388) is recognized by VS (and WinDbg).</p>
<p>Thus as a result, this works in all versions of Visual Studio but only while the Visual Studio debugger is attached to the process and will not be available in dumps or performance analysis tools.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Usage: SetThreadName ((DWORD)-1, "MainThread");</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="keyword">const</span> DWORD MS_VC_EXCEPTION = <span class="number">0x406D1388</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(push,8)</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">tagTHREADNAME_INFO</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    DWORD dwType; <span class="comment">// Must be 0x1000.</span></span><br><span class="line">    LPCSTR szName; <span class="comment">// Pointer to name (in user addr space).</span></span><br><span class="line">    DWORD dwThreadID; <span class="comment">// Thread ID (-1=caller thread).</span></span><br><span class="line">    DWORD dwFlags; <span class="comment">// Reserved for future use, must be zero.</span></span><br><span class="line">&#125; THREADNAME_INFO;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> pack(pop)</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">SetThreadName</span><span class="params">(DWORD dwThreadID, <span class="keyword">const</span> <span class="keyword">char</span>* threadName)</span> </span>&#123;</span><br><span class="line">    THREADNAME_INFO info;</span><br><span class="line">    info.dwType = <span class="number">0x1000</span>;</span><br><span class="line">    info.szName = threadName;</span><br><span class="line">    info.dwThreadID = dwThreadID;</span><br><span class="line">    info.dwFlags = <span class="number">0</span>;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(push)</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(disable: 6320 6322)</span></span><br><span class="line">    __try&#123;</span><br><span class="line">        RaiseException(MS_VC_EXCEPTION, <span class="number">0</span>, <span class="keyword">sizeof</span>(info) / <span class="keyword">sizeof</span>(ULONG_PTR), (ULONG_PTR*)&amp;info);</span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)&#123;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">pragma</span> <span class="meta-keyword">warning</span>(pop)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="SetThreadDescription"><a href="#SetThreadDescription" class="headerlink" title="SetThreadDescription"></a><a href="https://docs.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-setthreaddescription" target="_blank" rel="noopener">SetThreadDescription</a></h2><p><code>SetThreadDescription</code> is supported starting in Windows 10, version 1607 or Windows Server 2016 and are only visible debugging in Visual Studio 2017 version 15.6 and later versions regardless of whether or not the debugger was attached to the process at the time that SetThreadDescription is invoked.</p>
<p>Thread names are also visible when performing post-mortem debugging by loading a crash dump in Visual Studio or when using other tools, such as the <a href="https://docs.microsoft.com/zh-cn/windows-hardware/drivers/debugger/debugger-download-tools" target="_blank" rel="noopener">WinDbg</a> debugger and the <a href="https://docs.microsoft.com/zh-cn/windows-hardware/test/wpt/windows-performance-analyzer" target="_blank" rel="noopener">Windows Performance Analyzer</a> performance analyzer.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;processthreadsapi.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    HRESULT r;</span><br><span class="line">    r = SetThreadDescription(</span><br><span class="line">        GetCurrentThread(),</span><br><span class="line">        <span class="string">L"ThreadName"</span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Set-Thread-Name-using-phread"><a href="#Set-Thread-Name-using-phread" class="headerlink" title="Set Thread Name using phread"></a><a href="https://github.com/msys2-contrib/mingw-w64/commit/0d95c795b44b76e1b60dfc119fd93cfd0cb35816" target="_blank" rel="noopener">Set Thread Name using phread</a></h2><p>You are in luck if you are using mingw64 because it already implemented pthread. </p>
<p>Basically it’s the same as in Linux.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line">pthread_setname_np(thread.native_handle(), name)</span><br></pre></td></tr></table></figure>
          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/07/Books-2020-md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/07/Books-2020-md/" itemprop="url">
                  📖 Books of 2020
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-12-07 20:05:16" itemprop="dateCreated datePublished" datetime="2020-12-07T20:05:16-08:00">2020-12-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-31 13:25:39" itemprop="dateModified" datetime="2020-12-31T13:25:39-08:00">2020-12-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>✨<strong>Brave New World(Aldous Huxley)</strong></p>
<!-- restlessness and exhaustion This quote was my favorite at my first time reading this book: "But I don’t want comfort. I want God, I want poetry, I want real danger, I want freedom, I want goodness. I want sin."  shout out Does excessive freedom murder people's free mind?
1984对比 极致的压迫和过度的自由 你要哪一个呢 All conditioning aims at that: making people like their unescapable social destiny生活在两种
这半年呢 放纵又孤独 不想要情感上的东西 feel so lost after gettinf sober from alcohol  -->
<p>✨<strong>Being Mortal(Atul Gawande)</strong><br><!--为什么要读这本书呢，我经历过亲人的离开，身边朋友的离去， 我没有勇气面对这些离别，想要找到一些慰藉。
死亡是一件必然发生的事。
但我的收获更多在临终医疗，护理和养老。和美国社会不同，我爸爸妈妈觉得老了和子女一起生活是很正常的，在养老院度过很悲惨很孤独。社会结构和背景，医疗资源等等因素决定了人们的想法。体面的老去。人的尊严。
“Death ends a life, not a relationship.”
“As you grow, you learn more. Aging is not just decay…it’s growth. It’s more than the negative that you’re going to die, it’s also the positive that you understand that you’re going to die, and that you live a better life because of it.” --><br>✨<strong>Normal People(Sally Rooney)</strong><br><!--Most people go through their whole lives, without ever really feeling that close with anyone. Marianne and Connell found it from each other, even though I could not completely comprehend their love. I like how small things in life are accounted in the book, those scenes like just a leaf on the floor, an unconcious action, etc. I am obssessive with sensitive descriptions, and sensitive hearts too, which can always find out little unvisible sparklings. In some way I am feeling so related to Marianna, drowning in a sea of emotion. I feel not myself at the moment. Not in a bad way. I just feel outside of my life. There is something comforting. Something good about feeling sort of numb, detached from it all. I don't find it obvious what people want. I don't want to fit in anywhere. I belong nowhere. --></p>
<p>✨<strong>Zen and the Art of Motorcycle Maintenance(Robert M. Pirsig)</strong><br><!--Last time I read this book was couple years ago. I was not able to resonate at all, holding a naturally romatic personality, it bored me so much that I wanted to quit the reading many times. But this time this book did bring me more insights. 你必须先压制住自己的看法,否则你就无法读下去, 它是一个比沟里的死水还要沉闷的东西, 你会读到化油器, 齿轮, 压缩里等等,活塞,火花塞,进气等等, 如果从浪漫的角度来看就会觉得非常沉闷,丑陋而且十分笨拙,浪漫的人很少能突破这一点.  “You’ve got to live right, too. It’s the way you live that predisposes you to avoid the traps and see the right facts. You want to know how to paint a perfect painting? It’s easy. Make yourself perfect and then just paint naturally. That’s the way all the experts do it. The making of a painting or the fixing of a motorcycle isn’t separate from the rest of your existence. If you’re a sloppy thinker the six days of the week you aren’t working on your machine, what trap avoidance, what gimmicks, can make you all of a sudden sharp on the seventh? It all goes together ... The real cycle you're working in is a cycle called yourself. The machine that appears to be "out there" and the person that appears to be "in here" are not two separate things. They grow toward Quality or fall away from Quality together.”
如果你直接面对一个疯子,你所了解的就是他疯了, 这等于是根本不了解他. 要了解他,你就必须从他的角度看事情.
不可以在大太阳下直接修理车子,或者在你累了一整天下来脑筋不清楚的时候修理.
“When you want to hurry something, that means you no longer care about it and want to get on to other things.” “If your mind is truly, profoundly stuck, then it might be much better off than when it was loaded with ideas” 精确的仪器是为了表达一种理念而设计的.约翰认为我接触到的是各种零件,实际我接触的是各种观念.
“Who really can face the future? All you can do is project from the past, even when the past shows that such projections are often wrong. And who really can forget the past? What else is there to know?” The TV scientist who mutters sadly, "The experiment is a failure; we have failed to achieve what we had hoped for," is suffering mainly from a bad script writer. An experiment is never a failure solely because it fails to achieve predicted results. An experiment is a failure only when it also fails adequately to test the hypothesis in question, when the data it produces don't prove anything one way or another.
“Definitions are the foundation of reason. You can’t reason without them.”
Although motorcycle riding is romantic, motorcycle maintenance is purely classic. “The real purpose of the scientific method is to make sure nature hasn’t misled you into thinking you know something you actually don’t know.”
“(What makes his world so hard to see clearly is not its strangeness but its usualness).Familiarity can blind you too.” “You want to know how to paint a perfect painting? It's easy. Make yourself perfect and then just paint naturally.”
“We have artists with no scientific knowledge and scientists with no
artistic knowledge and both with no spiritual sense of gravity at all,
and the result is not just bad, it is ghastly.
“Familiarity can blind you”--></p>
<p>✨<strong>告别的仪式 (A Farewell to Sartre)(Simone de Beauvoir)</strong><br><!--Simone de Beauvoir's first-person account of the last ten years of Sartre's life. I used to describe them as Deliciously Complex. I also doubted their relationship maliciously. Satre, as a great philosopher, was so bossy and clever that he always made me feel their love was somehow not mutual. de Beauvoir may not be the only lover of Sartre, but she was definitely the most special and treasured one in his life. I decided not to question anymore because we human beings are just cutely vulnerable.--></p>
<p>✨<strong>Kim Ji-young: Born 1982(Cho Nam-joo)</strong><br><!--A story about a stay-at-home Korean mother driven to a psychotic break. I wasn’t as impressed with it as I thought I’d be because I've seen more terrible and cruel reality. I've never been a femilist, not been treated or hurt like that either, thanks to my family. But I grew up from an environment where everyone 实话说没有很深的感觉，因为我看过更悲痛的真实。我不是女性主义者，说实话也没有受到太强的伤害在这方面得益于我的家庭。但总体而言，我生长在一个对女性更加恶劣的环境和地区，见证了我从小周围几乎所有的女性都是家庭主妇包括我的妈妈，很多女生都没有自由支配自己的权利和能力。 We can say it's stale and platitudes just because it's being mentioned so many times. “There's this primary America of freeways and jet flights and TV and movie spectaculars, and people caught up in this primary America seem to go through huge portions of their lives without much consciousness of what immediately surrounds them. The media have convinced them that what's right around them is unimportant. And that's why they're lonely. “What was behind this smug presumption that what pleased you was bad or at least unimportant in comparison to other things? … Little children were trained not to do “just what they liked’ but … but what? … Of course! What others liked. And which others? Parents, teachers, supervisors, policemen, judges, officials, kings, dictators. All authorities. When you are trained to despise “just what you like” then, of course, you become a much more obedient servant of others -- a good slave. When you learn not to do “just what you like” then the System loves you.”--><br>✨<strong>Educated(Tara Westover)</strong><br><!--I run into Tara's life in this way. She grew up in a devout Mormon family in Iowa with her six siblings. Not trusting the government, their parents have been resisting hospitals, schools and all other public institutes. What they were doing daily was to prepare for the end of the world. Tara was like being in a dark isolated box, with a tiny hole to look at the outside. She did not know, that hole was made for her,  and what she was seeing was not everything. Finally at the age of 17, magically, all learning by herself, she passed the examination and entered Brigham Young University. Education gave a second birth to her. With a wholenew perspective, she revisited everything happened in her life: her father's psychological problems, her mother's ignorance and weakness, her brother's violence to her.  This book brought up a broad range of topics and questions about mainstream and margin--><br>✨<strong>And Then There Were None(Agatha Christie)</strong><br><!--Haven't read detective fictions for long. This one is just, classic. Not another word of it.  (I figured out who's the murderer halfway though)--><br>✨<strong>She said(Jodi Kantor and Megan Twohey)</strong></p>
<p>✨<strong>Essays in Love(Alain de Botton)</strong><br><!--Must being in love always mean being in pain?--><br>✨<strong>Good Economics for hard times(Abhijit Banerjee and Esther Duflo)</strong><br><!--Top 1 of my year. --></p>
<p>✨<strong>Tuesdays with Morrie(Mitch Albom)</strong><br><!--Read this through Audible in all my skateboarding time.   
"Detachment doesn’t mean you don’t let the experience penetrate you. On the contrary, you let it penetrate you fully. That’s how you are able to leave it."
“Don’t cling to things because everything is impermanent.”
“The culture we have does not make people feel good about themselves. And you have to be strong enough to say if the culture doesn’t work, don’t buy it.”--></p>
<p>✨<strong>Becoming(Renaada Williams)</strong><br><!--Poems writtern for broken hearts. I've read it many times, deeply moved by those beautiful, touching and curing words. "It took a lot for me to get to this point to come to the realization to know what I want to feel what I feel without second guessing to become who I am without any question." "You have to be the light for yourself even when nobody else see it." "I've been in so many pieces enough times to know how to put myself together again."--></p>
<p>✨<strong>冬泳(班宇)</strong><br><!-- 最喜欢的一篇是空中道路。浪漫主义 谈及华而不实的梦想
荒诞 个人和时代 超写实 两个中年男人的友谊 这是多么悠长的一个夜晚，他们两手空空，陡然轻松，走在梦境里，走在天上，甚至无需背负影子的重量。 --></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/11/15/Practices/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/11/15/Practices/" itemprop="url">
                  💻 How to Use CMake
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-11-15 20:54:41" itemprop="dateCreated datePublished" datetime="2020-11-15T20:54:41-08:00">2020-11-15</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-31 13:00:28" itemprop="dateModified" datetime="2020-12-31T13:00:28-08:00">2020-12-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I have been hating  build systems since I started to work as a software engineer, when tons of issues and problems using CMake has brought me huge frustration. This post is to summarize what I have learned on CMake system (Yes, after being tortured for such a long time😣). Hopefully I can use it more effectively in the future.</p>
<h1 id="What’s-CMake"><a href="#What’s-CMake" class="headerlink" title="What’s CMake?"></a>What’s CMake?</h1><p>Every time after we write the code, we will need the compiler to compile it and create executable files. These executable files are the ones that carry out the actual task. Only then, the end user could build and install the package, without knowing the details of how it’s done. </p>
<p>We could say, without a build system, a project is just a collection of files. There are many build tools to achieve a build system. </p>
<p>We can use Make. “GNU Make is a tool that controls the generation of executables and other non-source files of a program from the program’s source files.” It gets its knowledge of how to build your program from a file called the “makefile”. This makefile lists each of the non-source files and how to compute it from other files. When you write a program, you should write a makefile for it, so that it is possible to use “Make” to build and install the program. </p>
<p>Sounds simple huh? Yeah but only if you are writing small projects. Doing Make becomes pretty painful when you hand on a project with a large codebase running on different systems using different compilers, etc., you might have tedious dependencies, complex makefiles maintainance, and a lot more issues to deal with.</p>
<p>Here comes to CMake. <strong>As a build system generator, CMake stands for Cross-platform Make.</strong>  It has lots of advantages, not just overcoming the shortcomings of Make, in finding dependencies, protability, code generation. It supports different OSs, generators, multiple compilers, debuggers, multiple languages, etc.    </p>
<p>CMake reads the projects to build from CMakeLists.txt files. During configuring phrase, it builds up an internal representation of the entire project and then the generation phrase create the project files. From there the generated Makefiles can be used to build the project.</p>
<h1 id="CMake-V-S-Modern-CMake"><a href="#CMake-V-S-Modern-CMake" class="headerlink" title="CMake V.S. Modern CMake"></a>CMake V.S. Modern CMake</h1><p>Trust me, Modern CMake is gonna to save you from traditional CMake.</p>
<p>Modern CMake is only available starting with version 3.0.0., which advocates for abandoning a traditional variable-based approach for a more structured model based on targets. </p>
<h2 id="Targets-and-Properties"><a href="#Targets-and-Properties" class="headerlink" title="Targets and Properties"></a>Targets and Properties</h2><h3 id="Targets"><a href="#Targets" class="headerlink" title="Targets"></a>Targets</h3><p>An executable is a target, a library is a target. </p>
<table>
<thead>
<tr>
<th>Target Type</th>
<th>Command</th>
</tr>
</thead>
<tbody>
<tr>
<td>Executables</td>
<td>add_executable</td>
</tr>
<tr>
<td>Shared Libraries</td>
<td>add_library(SHARED)</td>
</tr>
<tr>
<td>Static Libraries</td>
<td>add_library(STATIC)</td>
</tr>
<tr>
<td>Object Libraries</td>
<td>add_library(OBJECT)</td>
</tr>
<tr>
<td>Interface Libraries</td>
<td>add_library(INTERFACE)</td>
</tr>
<tr>
<td>Alias Libraries</td>
<td>add_library(ALIAS)</td>
</tr>
</tbody>
</table>
<p>If you are familiar with shared libraries and static libraries, you can skip the following to Properties part.</p>
<h4 id="Shared-Libraries-V-S-Static-Libraries"><a href="#Shared-Libraries-V-S-Static-Libraries" class="headerlink" title="Shared Libraries V.S. Static Libraries"></a><a href="https://amir.rachum.com/blog/2016/09/17/shared-libraries/" target="_blank" rel="noopener">Shared Libraries V.S. Static Libraries</a></h4><p>A library is a file that contains compiled code and data.</p>
<h5 id="Static-Libraries"><a href="#Static-Libraries" class="headerlink" title="Static Libraries"></a><strong>Static Libraries</strong></h5><p>Linked into a compiled executable (or another library). After the compilation, the new artifact contains the static library’s content.</p>
<h5 id="Shared-Libraries"><a href="#Shared-Libraries" class="headerlink" title="Shared Libraries"></a><strong>Shared Libraries</strong></h5><p>Loaded by the executable (or other shared library) at runtime.</p>
<p><strong>Debugging Cheat Sheet</strong></p>
<p>If you ever get this error when running an executable:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ ./main</span><br><span class="line">./main: error while loading shared libraries: librandom.so: cannot open shared object file: No such file or directory</span><br></pre></td></tr></table></figure>
<p>Try doing the following:</p>
<ul>
<li>Find out what dependencies are missing with <code>ldd &lt;executable&gt;</code>.</li>
<li>If you don’t identify them, you can check if they are direct dependencies by running <code>readelf -d &lt;executable&gt; | grep NEEDED</code>.</li>
<li>Make sure the dependencies actually exist. Maybe you forgot to compile them or move them to a <code>libs</code> directory?</li>
<li>Find out where dependencies are searched by using <code>LD_DEBUG=libs ldd &lt;executable&gt;</code>.</li>
<li>If you need to add a directory to the search:<ul>
<li>add the directory to the <code>LD_LIBRARY_PATH</code> environment variable.</li>
<li>add the directory to the executable or shared library’s <code>rpath</code> or <code>runpath</code> by passing <code>-Wl,-rpath,&lt;dir&gt;</code> (for <code>rpath</code>) or <code>-Wl,--enable-new-dtags,-rpath,&lt;dir&gt;</code> (for <code>runpath</code>). Use <code>$ORIGIN</code> for paths relative to the executable.</li>
</ul>
</li>
<li>If <code>ldd</code> shows that no dependencies are missing, see if your application has elevated privileges. If so, <code>ldd</code> might lie. </li>
</ul>
<h3 id="Properties"><a href="#Properties" class="headerlink" title="Properties"></a>Properties</h3><p>Targets have properties. Properties of a target are the source files it’s built from, the compiler options it requires, the libraries it links against.</p>
<p>Target properties are defined in one of two scopes: <strong>INTERFACE</strong> and <strong>PRIVATE</strong>. Private properties are used <em>internally</em> to build the target, while interface properties are used <em>externally</em> by users of the target. In other words, interface properties model <strong>Usage-Requirements</strong>, whereas private properties model <strong>Build-Requirements</strong> of targets.</p>
<table>
<thead>
<tr>
<th></th>
<th>Traditional CMake</th>
<th>Modern CMake</th>
</tr>
</thead>
<tbody>
<tr>
<td>build-requirements are set on</td>
<td>environment</td>
<td>targets</td>
</tr>
<tr>
<td>keep track of usage-requirements via</td>
<td>(cache) variables</td>
<td>targets</td>
</tr>
<tr>
<td>usage-requirements propagation from dependency(target_link_libraries)</td>
<td>explicit propagation by hand (except paths to library-files)</td>
<td>automatic propagation</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># Adding build-requirements(usage-requirements)(both)</span><br><span class="line">target_include_directories(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;include-search-dir&gt;...)</span><br><span class="line">target_compile_definitions(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;macro-definitions&gt;...)</span><br><span class="line">target_compile_options(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;compiler-option&gt;...)</span><br><span class="line">target_compile_features(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;feature&gt;...)</span><br><span class="line">target_sources(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;source-file&gt;...)</span><br><span class="line">target_precompile_headers(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;header-file&gt;...)</span><br><span class="line">target_link_libraries(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;dependency&gt;...)</span><br><span class="line">target_link_options(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;linker-option&gt;...)</span><br><span class="line">target_link_directories(&lt;target&gt; PRIVATE(INTERFACE)(PUBLIC) &lt;linker-search-dir&gt;..)</span><br></pre></td></tr></table></figure>
<h1 id="Modern-CMake"><a href="#Modern-CMake" class="headerlink" title="Modern CMake"></a>Modern CMake</h1><h2 id="Basic-Usage-Template"><a href="#Basic-Usage-Template" class="headerlink" title="Basic Usage Template"></a>Basic Usage Template</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Minimum Version</span></span><br><span class="line">cmake_minimum_required(VERSION 3.7)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;CMAKE_VERSION&#125;</span> VERSION_LESS 3.19)</span><br><span class="line">    cmake_policy(VERSION <span class="variable">$&#123;CMAKE_MAJOR_VERSION&#125;</span>.<span class="variable">$&#123;CMAKE_MINOR_VERSION&#125;</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    cmake_policy(VERSION 3.19)</span><br><span class="line">endif()</span><br><span class="line"><span class="comment"># Setting a project</span></span><br><span class="line">project(MyProject VERSION 1.0</span><br><span class="line">                  DESCRIPTION <span class="string">"Example project"</span></span><br><span class="line">                  LANGUAGES CXX)</span><br><span class="line"><span class="comment"># Making an executable                </span></span><br><span class="line">add_executable(one two.cpp three.h)</span><br><span class="line"><span class="comment"># Making a library</span></span><br><span class="line">add_library(one STATIC two.cpp three.h)</span><br><span class="line">target_link_libraries(one PUBLIC calclib)</span><br><span class="line"><span class="comment"># add includes to targets</span></span><br><span class="line">target_include_directories(one PUBLIC include)</span><br><span class="line">target_compile_features(one PUBLIC cxx_std_11)</span><br><span class="line"><span class="comment"># add subdirectories</span></span><br><span class="line">add_subdirectory(libraries)</span><br></pre></td></tr></table></figure>
<p><strong>CMake Programming Note:</strong></p>
<p>Most CMake commands happen at configure time(eg: if statements). If you need logic to occur at build time or even install time, <a href="https://cmake.org/cmake/help/latest/manual/cmake-generator-expressions.7.html" target="_blank" rel="noopener">generator-expressions</a> were added for this purpose, which are evaluated in target properties.</p>
<p>If you want to put a compile flag only for the DEBUG configuration, you could do:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">target_compile_options(MyTarget PRIVATE &quot;$&lt;$&lt;CONFIG:Debug&gt;:--my-flag&gt;&quot;)</span><br><span class="line">target_include_directories(</span><br><span class="line">    MyTarget</span><br><span class="line">  PUBLIC</span><br><span class="line">    $&lt;BUILD_INTERFACE:$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/include&gt;</span><br><span class="line">    $&lt;INSTALL_INTERFACE:include&gt;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>Support for Generator Expressions. </p>
<p>• target_ commands </p>
<p>• file(GENERATE) command </p>
<p>• add_executable/add_library commands </p>
<p>• install command (partial) </p>
<p>• add_custom_target command (partial) </p>
<p>• add_custom_command command (partial)</p>
<p>There are others, but these are the most important.</p>
<h2 id="Adding-Features"><a href="#Adding-Features" class="headerlink" title="Adding Features"></a>Adding Features</h2><h3 id="Position-independent-code"><a href="#Position-independent-code" class="headerlink" title="Position independent code"></a>Position independent code</h3><p><a href="https://cmake.org/cmake/help/latest/variable/CMAKE_POSITION_INDEPENDENT_CODE.html" target="_blank" rel="noopener">This</a> is best known as the <code>-fPIC</code> flag. Position-<strong>independent</strong> code is not tied to a specific address, and can be loaded at different addresses in different processes. CMake will include the flag for <code>SHARED</code> or <code>MODULE</code> libraries. </p>
<p>But if you do explicitly need it:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span>(CMAKE_POSITION_INDEPENDENT_CODE <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure>
<p>will do it globally, or:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set_target_properties</span>(lib1 PROPERTIES POSITION_INDEPENDENT_CODE <span class="keyword">ON</span>)</span><br></pre></td></tr></table></figure>
<p>to explicitly turn it <code>ON</code> (or <code>OFF</code>) for a target.</p>
<h2 id="Useful-Modules"><a href="#Useful-Modules" class="headerlink" title="Useful Modules"></a>Useful Modules</h2><p>Here are a few highlights.</p>
<h3 id="CMakeDependentOption"><a href="#CMakeDependentOption" class="headerlink" title="CMakeDependentOption"></a><a href="https://cmake.org/cmake/help/latest/module/CMakeDependentOption.html" target="_blank" rel="noopener">CMakeDependentOption</a></h3><p>This adds a command <code>cmake_dependent_option</code> that sets an option based on another set of variables being true. </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CMakeDependentOption)</span><br><span class="line">cmake_dependent_option(BUILD_TESTS <span class="string">"Build your tests"</span> <span class="keyword">ON</span> <span class="string">"VAL1;VAL2"</span> <span class="keyword">OFF</span>)</span><br></pre></td></tr></table></figure>
<p>which is just a shortcut for this:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(VAL1 <span class="keyword">AND</span> VAL2)</span><br><span class="line">    <span class="keyword">set</span>(BUILD_TESTS_DEFAULT <span class="keyword">ON</span>)</span><br><span class="line"><span class="keyword">else</span>()</span><br><span class="line">    <span class="keyword">set</span>(BUILD_TESTS_DEFAULT <span class="keyword">OFF</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span>(BUILD_TESTS <span class="string">"Build your tests"</span> <span class="variable">$&#123;BUILD_TESTS_DEFAULT&#125;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT BUILD_TESTS_DEFAULT)</span><br><span class="line">    <span class="keyword">mark_as_advanced</span>(BUILD_TESTS)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>Note that <code>BUILD_TESTING</code> is a better way to check for testing being enabled if you use <code>include(CTest)</code>, since it is defined for you.</p>
<h3 id="CMakePrintHelpers"><a href="#CMakePrintHelpers" class="headerlink" title="CMakePrintHelpers"></a><a href="https://cmake.org/cmake/help/latest/module/CMakePrintHelpers.html" target="_blank" rel="noopener">CMakePrintHelpers</a></h3><p>This module has a couple of handy output functions. <code>cmake_print_properties</code> lets you easily print properties. And <code>cmake_print_variables</code> will print the names and values of any variables you give it.</p>
<h3 id="CheckCXXCompilerFlag"><a href="#CheckCXXCompilerFlag" class="headerlink" title="CheckCXXCompilerFlag"></a><a href="https://cmake.org/cmake/help/latest/module/CheckCXXCompilerFlag.html" target="_blank" rel="noopener">CheckCXXCompilerFlag</a></h3><p>This checks to see if a flag is supported. For example:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(CheckCXXCompilerFlag)</span><br><span class="line">check_cxx_compiler_flag(-someflag OUTPUT_VARIABLE)</span><br></pre></td></tr></table></figure>
<p>Similar modules, such as <code>CheckIncludeFileCXX</code>, <code>CheckStructHasMember</code>, <code>TestBigEndian</code>, and <code>CheckTypeSize</code> that allow you to check for information about the system and you can communicate that to your source code.</p>
<h3 id="WriteCompilerDetectionHeader"><a href="#WriteCompilerDetectionHeader" class="headerlink" title="WriteCompilerDetectionHeader"></a><a href="https://cmake.org/cmake/help/latest/module/WriteCompilerDetectionHeader.html" target="_blank" rel="noopener">WriteCompilerDetectionHeader</a></h3><p>It allows you to look for a list of features that some compilers support, and write out a C++ header file that lets you know whether that feature is available. It even can provide compatibility macros for features that have changed names!</p>
<p>To use:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">write_compiler_detection_header(</span><br><span class="line">  FILE myoutput.h</span><br><span class="line">  PREFIX My</span><br><span class="line">  COMPILERS GNU Clang MSVC Intel</span><br><span class="line">  FEATURES cxx_variadic_templates</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>This supports compiler features (defined to 0 or 1), symbols (defined to empty or the symbol), and macros that support different names. They will be prefixed with the PREFIX you provide. You can separate compilers into different files using <code>OUTPUT_FILES_DIR</code>.</p>
<p>The downside is that you do have to list the compilers you expect to support. If you use the <code>ALLOW_UNKNOWN_COMPILERS</code> flag(s), you can keep this from erroring on unknown compilers, but it will still leave all features empty.</p>
<h3 id="try-compile-try-run"><a href="#try-compile-try-run" class="headerlink" title="try_compile/try_run"></a><a href="https://cmake.org/cmake/help/latest/command/try_compile.html" target="_blank" rel="noopener"><code>try_compile</code></a>/<a href="https://cmake.org/cmake/help/latest/command/try_run.html" target="_blank" rel="noopener"><code>try_run</code></a></h3><p>This is not exactly a module, but is crucial to many of the modules listed above. You can attempt to compile  or run a bit of code at configure time. This can allow you to get information about the capabilities of your system. The basic syntax is:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try_compile</span>(</span><br><span class="line">  RESULT_VAR</span><br><span class="line">    bindir</span><br><span class="line">  SOURCES</span><br><span class="line">    source.cpp</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>There are lots of options you can add, like <code>COMPILE_DEFINITIONS</code>. In CMake 3.8+, this will honor the CMake C/C++/CUDA standard settings. If you use <code>try_run</code> instead, it will run the resulting program and give you the output in <code>RUN_OUTPUT_VARIABLE</code>.</p>
<h3 id="FeatureSummary"><a href="#FeatureSummary" class="headerlink" title="FeatureSummary"></a><a href="https://cmake.org/cmake/help/latest/module/FeatureSummary.html" target="_blank" rel="noopener">FeatureSummary</a></h3><p>It allows you to print out a list of packages what were searched for, as well as any options you explicity mark. It’s partially but not completely tied into <a href="https://cmake.org/cmake/help/latest/command/find_package.html" target="_blank" rel="noopener"><code>find_package</code></a>. </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FeatureSummary)</span><br></pre></td></tr></table></figure>
<p>Then, for any find packages you have run or will run, you can extend the default information:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set_package_properties(OpenMP PROPERTIES</span><br><span class="line">    URL <span class="string">"http://www.openmp.org"</span></span><br><span class="line">    DESCRIPTION <span class="string">"Parallel compiler directives"</span></span><br><span class="line">    PURPOSE <span class="string">"This is what it does in my package"</span>)</span><br></pre></td></tr></table></figure>
<p>You can also set the <code>TYPE</code> of a package to <code>RUNTIME</code>, <code>OPTIONAL</code>, <code>RECOMMENDED</code>, or <code>REQUIRED</code>; you can’t, however, lower the type of a package; if you have already added a <code>REQUIRED</code> package through <a href="https://cmake.org/cmake/help/latest/command/find_package.html" target="_blank" rel="noopener"><code>find_package</code></a> based on an option, you’ll see it listed as <code>REQUIRED</code>.</p>
<p>And, you can mark any options as part of the feature summary. If you choose the same name as a package, the two interact with each other.</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">add_feature_info(WITH_OPENMP OpenMP_CXX_FOUND <span class="string">"OpenMP (Thread safe FCNs only)"</span>)</span><br></pre></td></tr></table></figure>
<p>Then, you can print out the summary of features, either to the screen or a log file:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(CMAKE_PROJECT_NAME <span class="keyword">STREQUAL</span> PROJECT_NAME)</span><br><span class="line">    feature_summary(WHAT ENABLED_FEATURES DISABLED_FEATURES PACKAGES_FOUND)</span><br><span class="line">    feature_summary(FILENAME <span class="variable">$&#123;CMAKE_CURRENT_BINARY_DIR&#125;</span>/features.log WHAT ALL)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>You can build any collection of <code>WHAT</code> items that you like, or just use <code>ALL</code>.</p>
<h2 id="Including-Projects"><a href="#Including-Projects" class="headerlink" title="Including Projects"></a>Including Projects</h2><h3 id="Git-Submodule-Method"><a href="#Git-Submodule-Method" class="headerlink" title="Git Submodule Method"></a>Git Submodule Method</h3><p>If you want to add a Git repository on the same service (GitHub, GitLab, BitBucket, etc), the following is the correct Git command to set that up as a submodule in the <code>extern</code> directory:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitbook $ git submodule add ../../owner/repo.git extern/repo</span><br></pre></td></tr></table></figure>
<p>The relative path to the repo is important; it allows you to keep the same access method (ssh or https) as the parent repository. When you are inside the submodule, you can treat it just like a normal repo, and when you are in the parent repository, you can “add” to change the current commit pointer.</p>
<p>But the traditional downside is that you either have to have your users know git submodule commands, so they can <code>init</code> and <code>update</code> the repo, or they have to add <code>--recursive</code> when they initially clone your repo. CMake can offer a solution:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># checks for Git using CMake's built in `FindGit.cmake`.</span></span><br><span class="line"><span class="keyword">find_package</span>(Git QUIET)</span><br><span class="line"><span class="keyword">if</span>(GIT_FOUND <span class="keyword">AND</span> EXISTS <span class="string">"$&#123;PROJECT_SOURCE_DIR&#125;/.git"</span>)</span><br><span class="line"><span class="comment"># Update submodules as needed</span></span><br><span class="line">    <span class="comment"># if you are in a git checkout of your source, add an option (defaulting to `ON`) </span></span><br><span class="line">    <span class="comment"># that allows developers to turn off the feature if they need to</span></span><br><span class="line">    <span class="keyword">option</span>(GIT_SUBMODULE <span class="string">"Check submodules during build"</span> <span class="keyword">ON</span>)</span><br><span class="line">    <span class="keyword">if</span>(GIT_SUBMODULE)</span><br><span class="line">        <span class="keyword">message</span>(STATUS <span class="string">"Submodule update"</span>)</span><br><span class="line">        <span class="keyword">execute_process</span>(COMMAND <span class="variable">$&#123;GIT_EXECUTABLE&#125;</span> submodule update --init --recursive</span><br><span class="line">                        WORKING_DIRECTORY <span class="variable">$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;</span></span><br><span class="line">                        RESULT_VARIABLE GIT_SUBMOD_RESULT)</span><br><span class="line">        <span class="keyword">if</span>(NOT GIT_SUBMOD_RESULT <span class="keyword">EQUAL</span> <span class="string">"0"</span>)</span><br><span class="line">            <span class="keyword">message</span>(FATAL_ERROR <span class="string">"git submodule update --init failed with $&#123;GIT_SUBMOD_RESULT&#125;, please checkout submodules"</span>)</span><br><span class="line">        <span class="keyword">endif</span>()</span><br><span class="line">    <span class="keyword">endif</span>()</span><br><span class="line"><span class="keyword">endif</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(NOT EXISTS <span class="string">"$&#123;PROJECT_SOURCE_DIR&#125;/extern/repo/CMakeLists.txt"</span>)</span><br><span class="line">    <span class="keyword">message</span>(FATAL_ERROR <span class="string">"The submodules were not downloaded! GIT_SUBMODULE was turned off or failed. Please update submodules and try again."</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>Now, your users can be completely oblivious to the existence of the submodules, and you can still keep up good development practices! The only thing to watch out for is for developers; you will reset the submodule when you rerun CMake if you are developing inside the submodule. Just add new commits to the parent staging area, and you’ll be fine.</p>
<p>You can then include projects that provide good CMake support:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">add_subdirectory</span>(extern/repo)</span><br></pre></td></tr></table></figure>
<p>Or, you can build an interface library target yourself if it is a header only project. Or, you can use <code>find_package</code> if that is supported, probably preparing the initial search directory to be the one you’ve added (check the docs or the file for the <code>Find*.cmake</code> file you are using). You can also include a CMake helper file directory if you append to your <code>CMAKE_MODULE_PATH</code>.</p>
<h3 id="ExternalProject"><a href="#ExternalProject" class="headerlink" title="ExternalProject"></a>ExternalProject</h3><p>Run while compiling, can’t use  <code>add_subdirectory</code> in configuration.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ExternalProject_Add(&lt;name&gt; [&lt;option&gt;...])</span><br><span class="line">ExternalProject_Add_Step(&lt;name&gt; &lt;step&gt; [&lt;option&gt;...])</span><br><span class="line">ExternalProject_Get_Property</span><br><span class="line">ExternalProject_Add_StepTargets(&lt;name&gt; [NO_DEPENDS] &lt;step1&gt; [&lt;step2&gt;...])</span><br></pre></td></tr></table></figure>
<p>Example:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">ExternalProject_Add(project_example</span><br><span class="line">  URL http://.../project_example.tar.gz</span><br><span class="line">  PREFIX $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/project_example</span><br><span class="line">  CONFIGURE_COMMAND &quot;&quot;</span><br><span class="line">  BUILD_COMMAND make</span><br><span class="line">  INSTALL_COMMAND make install</span><br><span class="line">  PREFIX=$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/project_example</span><br><span class="line">)</span><br><span class="line">ExternalProject_Get_Property(project_example install_dir)</span><br><span class="line">add_library(example STATIC IMPORTED)</span><br><span class="line">set_property(TARGET example PROPERTY IMPORTED_LOCATION $&#123;install_dir&#125;/lib/example.a)</span><br><span class="line">add_dependencies(example project_example)</span><br><span class="line"></span><br><span class="line">add_executable(myapp main.c)</span><br><span class="line">include_directories($&#123;install_dir&#125;/include/example)</span><br><span class="line">target_link_libraries(myapp example)</span><br></pre></td></tr></table></figure>
<h4 id="vcpkg"><a href="#vcpkg" class="headerlink" title="vcpkg"></a><a href="https://docs.microsoft.com/en-us/cpp/build/vcpkg?view=msvc-160" target="_blank" rel="noopener">vcpkg</a></h4><p>a cross-platform command-line package manager for C and C++ libraries</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># install vcpkg</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/Microsoft/vcpkg.git</span><br><span class="line"><span class="built_in">cd</span> vcpkg</span><br><span class="line">./bootstrap-vcpkg.sh</span><br><span class="line"><span class="comment"># install required package, eg: opencv</span></span><br><span class="line">vcpkg install opencv</span><br><span class="line"><span class="comment"># add these to your program</span></span><br><span class="line">find_package(OpenCV REQUIRED)</span><br><span class="line">target_link_libraries(target <span class="variable">$&#123;OpenCV_LIBS&#125;</span>)</span><br><span class="line"><span class="comment"># CMake configure</span></span><br><span class="line">cmake .. -DCMAKE_TOOLCHAIN_FILE=path/to/vcpkg/scripts/buildsystems/vcpkg.cmake</span><br><span class="line"><span class="comment"># for usage convenience</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="string">"path/to/vcpkg/:<span class="variable">$PATH</span>"</span></span><br></pre></td></tr></table></figure>
<h3 id="DownloadProject"><a href="#DownloadProject" class="headerlink" title="DownloadProject"></a><a href="https://github.com/Crascit/DownloadProject" target="_blank" rel="noopener">DownloadProject</a></h3><p>Download an external project’s source at CMake’s configure step rather than as part of the main build.</p>
<p>The primary advantage is that the project’s source code can then be included directly in the main CMake build using the  <code>add_subdirectory</code> command, making all of the external project’s targets, etc. available without any further effort.</p>
<h3 id="FetchContent-CMake-3-11-："><a href="#FetchContent-CMake-3-11-：" class="headerlink" title="FetchContent  (CMake 3.11+)："></a><a href="https://cmake.org/cmake/help/latest/module/FetchContent.html" target="_blank" rel="noopener">FetchContent</a>  (CMake 3.11+)：</h3><p>Do your download of data or packages as part of the configure instead of the build, similar as DownloadProject.</p>
<p>The key ideas are:</p>
<ul>
<li>Use <code>FetchContent_Declare(MyName)</code> to get data or a package. You can set URLs, Git repositories, and more.</li>
<li>Use <code>FetchContent_GetProperties(MyName)</code> on the name you picked in the first step to get <code>MyName_*</code> variables.</li>
<li>Check <code>MyName_POPULATED</code>, and if not populated, use <code>FetchContent_Populate(MyName)</code> (and if a package, <code>add_subdirectory(&quot;${MyName_SOURCE_DIR}&quot; &quot;${MyName_BINARY_DIR}&quot;)</code>)</li>
</ul>
<p>For example, to download Catch2:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">include</span>(FetchContent)</span><br><span class="line">FetchContent_Declare(</span><br><span class="line">  catch</span><br><span class="line">  GIT_REPOSITORY https://github.com/catchorg/Catch2.git</span><br><span class="line">  GIT_TAG        v2.<span class="number">13.0</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># CMake 3.14+</span></span><br><span class="line">FetchContent_MakeAvailable(catch)</span><br></pre></td></tr></table></figure>
<p>If you can’t use CMake 3.14+, the classic way to prepare code was:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># CMake 3.11+</span></span><br><span class="line">FetchContent_GetProperties(catch)</span><br><span class="line"><span class="keyword">if</span>(NOT catch_POPULATED)</span><br><span class="line">  FetchContent_Populate(catch)</span><br><span class="line">  <span class="keyword">add_subdirectory</span>(<span class="variable">$&#123;catch_SOURCE_DIR&#125;</span> <span class="variable">$&#123;catch_BINARY_DIR&#125;</span>)</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<p>Of course, you could bundled this up into a macro:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable">$&#123;CMAKE_VERSION&#125;</span> VERSION_LESS <span class="number">3.14</span>)</span><br><span class="line">    <span class="keyword">macro</span>(FetchContent_MakeAvailable NAME)</span><br><span class="line">        FetchContent_GetProperties(<span class="variable">$&#123;NAME&#125;</span>)</span><br><span class="line">        <span class="keyword">if</span>(NOT <span class="variable">$&#123;NAME&#125;</span>_POPULATED)</span><br><span class="line">            FetchContent_Populate(<span class="variable">$&#123;NAME&#125;</span>)</span><br><span class="line">            <span class="keyword">add_subdirectory</span>(<span class="variable">$&#123;$&#123;NAME&#125;</span>_SOURCE_DIR&#125; <span class="variable">$&#123;$&#123;NAME&#125;</span>_BINARY_DIR&#125;)</span><br><span class="line">        <span class="keyword">endif</span>()</span><br><span class="line">    <span class="keyword">endmacro</span>()</span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<h2 id="Export-targets-and-find-package"><a href="#Export-targets-and-find-package" class="headerlink" title="Export targets and find_package()"></a>Export targets and find_package()</h2><h3 id="Defining-a-library"><a href="#Defining-a-library" class="headerlink" title="Defining a library"></a>Defining a library</h3><p>Define the library and variable that will be used to generate CMake packages.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CMakeLists.txt</span><br><span class="line">include(GNUInstallDirs)</span><br><span class="line">include(CMakePackageConfigHelpers)</span><br><span class="line">set(INSTALL_CMAKE_DIR $&#123;CMAKE_INSTALL_LIBDIR&#125;/cmake/$&#123;PROJECT_NAME&#125;)</span><br><span class="line">set(TARGETS_EXPORT_NAME &quot;$&#123;PROJECT_NAME&#125;Targets&quot;)</span><br><span class="line">set(generated_dir &quot;$&#123;CMAKE_CURRENT_BINARY_DIR&#125;/generated&quot;)</span><br><span class="line">set(project_config &quot;$&#123;generated_dir&#125;/$&#123;PROJECT_NAME&#125;Config.cmake&quot;)</span><br><span class="line">set(version_config &quot;$&#123;generated_dir&#125;/$&#123;PROJECT_NAME&#125;ConfigVersion.cmake&quot;)</span><br><span class="line">add_library($&#123;PROJECT_NAME&#125; SHARED $&#123;PROJECT_NAME&#125;.cpp)</span><br><span class="line">set_target_properties($&#123;PROJECT_NAME&#125; PROPERTIES</span><br><span class="line"> VERSION &quot;$&#123;PROJECT_VERSION&#125;&quot;</span><br><span class="line"> SOVERSION &quot;$&#123;PROJECT_VERSION_MAJOR&#125;.$&#123;PROJECT_VERSION_MINOR&#125;&quot;</span><br><span class="line"> PUBLIC_HEADER &quot;$&#123;PROJECT_NAME&#125;.h&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="Include-Directories"><a href="#Include-Directories" class="headerlink" title="Include Directories"></a>Include Directories</h3><p>When setting up the include paths for your project it is necessary to use generator expressions when setting the target_include_directories command. Public includes must have a BUILD_INTERFACE and an INSTALL_INTERFACE so that the exported library will have the correct include paths in the generated files.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">target_include_directories($&#123;PROJECT_NAME&#125;</span><br><span class="line"> PUBLIC</span><br><span class="line"> $&lt;BUILD_INTERFACE:$&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/include&gt;</span><br><span class="line"> $&lt;INSTALL_INTERFACE:$&#123;CMAKE_INSTALL_INCLUDEDIR&#125;&gt;</span><br><span class="line">)</span><br><span class="line">install(DIRECTORY</span><br><span class="line"> $&#123;CMAKE_CURRENT_SOURCE_DIR&#125;/include/</span><br><span class="line"> DESTINATION $&#123;CMAKE_INSTALL_INCLUDEDIR&#125;</span><br><span class="line"> FILES_MATCHING PATTERN &quot;*.h&quot;</span><br><span class="line">)</span><br><span class="line">install(TARGETS $&#123;PROJECT_NAME&#125;</span><br><span class="line"> EXPORT $&#123;TARGETS_EXPORT_NAME&#125;</span><br><span class="line"> LIBRARY DESTINATION $&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br><span class="line"> PUBLIC_HEADER DESTINATION $&#123;CMAKE_INSTALL_INCLUDEDIR&#125;)</span><br></pre></td></tr></table></figure>
<h3 id="CMake-config-setup"><a href="#CMake-config-setup" class="headerlink" title="CMake config setup"></a>CMake config setup</h3><p>Add the generation logic to the CMakeLists.txt file</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">write_basic_package_version_file(</span><br><span class="line"> &quot;$&#123;version_config&#125;&quot;</span><br><span class="line"> VERSION $&#123;PROJECT_VERSION&#125;</span><br><span class="line"> COMPATIBILITY SameMajorVersion</span><br><span class="line">)</span><br><span class="line">configure_package_config_file(config.cmake.in</span><br><span class="line"> &quot;$&#123;project_config&#125;&quot;</span><br><span class="line"> INSTALL_DESTINATION $&#123;INSTALL_CMAKE_DIR&#125;</span><br><span class="line">)</span><br><span class="line">install(</span><br><span class="line"> EXPORT &quot;$&#123;TARGETS_EXPORT_NAME&#125;&quot;</span><br><span class="line"> NAMESPACE &quot;$&#123;PROJECT_NAME&#125;::&quot;</span><br><span class="line"> DESTINATION $&#123;INSTALL_CMAKE_DIR&#125;</span><br><span class="line">)</span><br><span class="line">install(</span><br><span class="line"> FILES $&#123;version_config&#125; $&#123;project_config&#125;</span><br><span class="line"> DESTINATION $&#123;INSTALL_CMAKE_DIR&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>The template file used during the config setup.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config.cmake.in</span><br><span class="line">@PACKAGE_INIT@</span><br><span class="line">include(&quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/@TARGETS_EXPORT_NAME@.cmake&quot;)</span><br><span class="line">set(@PROJECT_NAME@_INCLUDE_DIRS $&#123;PACKAGE_PREFIX_DIR&#125;/include)</span><br><span class="line">set(@PROJECT_NAME@_LIBRARIES @PROJECT_NAME@::@PROJECT_NAME@)</span><br><span class="line">check_required_components(&quot;@PROJECT_NAME@&quot;)</span><br></pre></td></tr></table></figure>
<h3 id="Consuming-CMake-config-modules"><a href="#Consuming-CMake-config-modules" class="headerlink" title="Consuming CMake config modules"></a>Consuming CMake config modules</h3><p>Build the executable and link against the new libraries</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">find_package(libA 0.1.0 REQUIRED)</span><br><span class="line">find_package(libB 0.1.0 REQUIRED)</span><br><span class="line">set(CMAKE_INSTALL_RPATH &quot;$&#123;CMAKE_INSTALL_PREFIX&#125;/lib&quot;)</span><br><span class="line">set(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)</span><br><span class="line">add_executable($&#123;PROJECT_NAME&#125; $&#123;PROJECT_NAME&#125;.cpp)</span><br><span class="line">target_link_libraries($&#123;PROJECT_NAME&#125;</span><br><span class="line"> $&#123;libA_LIBRARIES&#125;</span><br><span class="line"> $&#123;libB_LIBRARIES&#125;</span><br><span class="line"> )</span><br><span class="line">target_include_directories($&#123;PROJECT_NAME&#125; PUBLIC</span><br><span class="line"> $&#123;libA_INCLUDE_DIRS&#125;</span><br><span class="line"> $&#123;libB_INCLUDE_DIRS&#125;</span><br><span class="line">)</span><br><span class="line">install(TARGETS $&#123;PROJECT_NAME&#125;</span><br><span class="line"> RUNTIME DESTINATION $&#123;CMAKE_INSTALL_BINDIR&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="Traditional-Library-pkg-config-configuration-Solution"><a href="#Traditional-Library-pkg-config-configuration-Solution" class="headerlink" title="Traditional Library pkg-config configuration Solution"></a>Traditional Library pkg-config configuration Solution</h3><p>For libraries using older version CMake, the above solution may not be working. Here is a solution.</p>
<h4 id="Defining-a-library-1"><a href="#Defining-a-library-1" class="headerlink" title="Defining a library"></a>Defining a library</h4><p>When creating a library consider using set_target_properties to define the version of the library and the public headers for the library.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">CMakeLists.txt</span><br><span class="line"># Paths from GNUInstallDirs are relative paths.</span><br><span class="line">include(GNUInstallDirs)</span><br><span class="line">include(CMakePackageConfigHelpers)</span><br><span class="line">add_library($&#123;PROJECT_NAME&#125; SHARED $&#123;PROJECT_NAME&#125;.cpp)</span><br><span class="line">set_target_properties($&#123;PROJECT_NAME&#125; PROPERTIES</span><br><span class="line"> VERSION &quot;$&#123;PROJECT_VERSION&#125;&quot;</span><br><span class="line"> SOVERSION &quot;$&#123;PROJECT_VERSION_MAJOR&#125;.$&#123;PROJECT_VERSION_MINOR&#125;&quot;</span><br><span class="line"> PUBLIC_HEADER &quot;$&#123;PROJECT_NAME&#125;.h&quot;)</span><br><span class="line"># When installing a library be sure to use a relative path to the DESTINATION.</span><br><span class="line"># That will make the exported target relocatable which is necessary for sysroots created by BitBake.</span><br><span class="line">install(TARGETS $&#123;PROJECT_NAME&#125;</span><br><span class="line"> LIBRARY DESTINATION $&#123;CMAKE_INSTALL_LIBDIR&#125;</span><br><span class="line"> PUBLIC_HEADER DESTINATION $&#123;CMAKE_INSTALL_INCLUDEDIR&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="Pkg-config-setup"><a href="#Pkg-config-setup" class="headerlink" title="Pkg-config setup"></a>Pkg-config setup</h4><p>Create and install a pkg-config file by using a template and substituting cmake variables.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ProjectName.pc.in</span><br><span class="line">prefix=@CMAKE_INSTALL_PREFIX@</span><br><span class="line">exec_prefix=$&#123;prefix&#125;</span><br><span class="line">libdir=$&#123;prefix&#125;/@CMAKE_INSTALL_LIBDIR@</span><br><span class="line">includedir=$&#123;prefix&#125;/@CMAKE_INSTALL_INCLUDEDIR@</span><br><span class="line">Name: @PROJECT_NAME@-@PROJECT_VERSION@</span><br><span class="line">Description: @PROJECT_NAME@</span><br><span class="line">Version: @PROJECT_VERSION_MAJOR@.@PROJECT_VERSION_MINOR@.@PROJECT_VERSION_PATCH@</span><br><span class="line">Libs: -L$&#123;libdir&#125; -l@PROJECT_NAME@</span><br><span class="line">Cflags: -I$&#123;includedir&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CMakeLists.txt</span><br><span class="line">configure_file($&#123;PROJECT_NAME&#125;.pc.in $&#123;PROJECT_NAME&#125;.pc @ONLY)</span><br><span class="line">install(FILES $&#123;CMAKE_CURRENT_BINARY_DIR&#125;/$&#123;PROJECT_NAME&#125;.pc</span><br><span class="line"> DESTINATION $&#123;CMAKE_INSTALL_LIBDIR&#125;/pkgconfig)</span><br></pre></td></tr></table></figure>
<h4 id="Consuming-libraries"><a href="#Consuming-libraries" class="headerlink" title="Consuming libraries"></a>Consuming libraries</h4><p>Use the FindPkgConfig module to search for the pkg-config files that have been installed.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find_package(PkgConfig REQUIRED)</span><br><span class="line">pkg_check_modules(NAMESPACE_A REQUIRED libA)</span><br><span class="line">pkg_check_modules(NAMESPACE_B REQUIRED libB)</span><br></pre></td></tr></table></figure>
<p>Adjust the RPATH so that the new binary can use the library that may be installed into a separate prefix</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set(CMAKE_INSTALL_RPATH &quot;$&#123;CMAKE_INSTALL_PREFIX&#125;/lib&quot;)</span><br><span class="line">set(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)</span><br></pre></td></tr></table></figure>
<p>Change the link_directories so that the linker knows where to search for the new libraries.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">link_directories($&#123;NAMESPACE_A_LIBRARY_DIRS&#125; $&#123;NAMESPACE_B_LIBRARY_DIRS&#125;)</span><br></pre></td></tr></table></figure>
<p>Define your target and add the correct compiler options.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">add_executable($&#123;PROJECT_NAME&#125; $&#123;PROJECT_NAME&#125;.cpp)</span><br><span class="line">target_link_libraries($&#123;PROJECT_NAME&#125;</span><br><span class="line"> $&#123;NAMESPACE_A_LIBRARIES&#125;</span><br><span class="line"> $&#123;NAMESPACE_B_LIBRARIES&#125;</span><br><span class="line"> )</span><br><span class="line">target_include_directories($&#123;PROJECT_NAME&#125; PUBLIC $&#123;NAMESPACE_A_INCLUDE_DIRS&#125; $&#123;NAMESPACE_B_INCLUDE_DIRS&#125;)</span><br><span class="line">target_compile_options($&#123;PROJECT_NAME&#125; PUBLIC $&#123;NAMESPACE_A_CFLAGS_OTHER&#125; $&#123;NAMESPACE_B_CFLAGS_OTHER&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="Utilities"><a href="#Utilities" class="headerlink" title="Utilities"></a>Utilities</h2><p>Set the following properties or <code>CMAKE_*</code> initializer variables to the command line for the tools. Most of them are limited to C or CXX with make or ninja generators.</p>
<ul>
<li><code>&lt;LANG&gt;_CLANG_TIDY</code>: CMake 3.6+</li>
<li><code>&lt;LANG&gt;_CPPCHECK</code></li>
<li><code>&lt;LANG&gt;_CPPLINT</code></li>
<li><code>&lt;LANG&gt;_INCLUDE_WHAT_YOU_USE</code></li>
</ul>
<h3 id="Clang-tidy"><a href="#Clang-tidy" class="headerlink" title="Clang tidy"></a>Clang tidy</h3><p>Here is a simple example of using Clang-Tidy:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmake -S . -B build-tidy -DCMAKE_CXX_CLANG_TIDY=<span class="string">"<span class="variable">$(which clang-tidy)</span>;-fix"</span></span><br><span class="line">cmake --build build -j 1</span><br></pre></td></tr></table></figure>
<p>The <code>-fix</code> part is optional, and will modify your source files to try to fix the tidy warning issued. If you are working in a git repository, this is fairly safe as you can see what has changed. However, make sure you <strong>do not run your makefile/ninja build in parallel</strong>! This will not work very well at all if it tries to fix the same header twice.</p>
<p>If you want to explicitly use the target form to ensure you only call this on your local targets, you can set a variable (maybe something like <code>DO_CLANG_TIDY</code>) instead of the <code>CMAKE_CXX_CLANG_TIDY</code> variable, then add it to your target properties as you create them. You can find clang-tidy in your path like this:</p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_program</span>(</span><br><span class="line">    CLANG_TIDY_EXE</span><br><span class="line">    NAMES <span class="string">"clang-tidy"</span></span><br><span class="line">    DOC <span class="string">"Path to clang-tidy executable"</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="Include-what-you-use"><a href="#Include-what-you-use" class="headerlink" title="Include what you use"></a>Include what you use</h3><p>This is an example for using include what you use. First, you’ll need to have the tool, such as in a docker container or with brew (macOS) with <code>brew install include-what-you-use</code>. Then, you can pass this into your build without modifying the source:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build # cmake -S . -B build-iwyu -DCMAKE_CXX_INCLUDE_WHAT_YOU_USE=include-what-you-use</span><br></pre></td></tr></table></figure>
<p>Finally, you can collect the output and (optionally) apply the fixes:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">build # cmake --build build-iwyu 2&gt; iwyu.out build # fix_includes.py &lt; iwyu.out</span><br></pre></td></tr></table></figure>
<p>(You should check the fixes first, or touch them up after applying!)</p>
<h3 id="Link-what-you-use"><a href="#Link-what-you-use" class="headerlink" title="Link what you use"></a>Link what you use</h3><p>There is a boolean target property, <code>LINK_WHAT_YOU_USE</code>, that will check for extraneous files when linking.</p>
<h3 id="Clang-format"><a href="#Clang-format" class="headerlink" title="Clang-format"></a>Clang-format</h3><p>Clang-format doesn’t really have an integration with CMake, unfortunately. You could make a custom target (See <a href="https://arcanis.me/en/2015/10/17/cppcheck-and-clang-format" target="_blank" rel="noopener">this post</a>, or you can run it manually. An interesting project that I have not really tried is <a href="https://github.com/kbenzie/git-cmake-format" target="_blank" rel="noopener">here</a>; it adds a format target and even makes sure that you can’t commit unformatted files.</p>
<p>The following two line would do that in a git repository in bash (assuming you have a <code>.clang-format</code> file):</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gitbook $ git ls-files -- &apos;*.cpp&apos; &apos;*.h&apos; | xargs clang-format -i -style=file gitbook $ git diff --exit-code --color</span><br></pre></td></tr></table></figure>
<p>## </p>
<h2 id="Speed-up-configuring-and-building"><a href="#Speed-up-configuring-and-building" class="headerlink" title="Speed up configuring and building"></a>Speed up configuring and building</h2><h3 id="CCache"><a href="#CCache" class="headerlink" title="CCache"></a>CCache</h3><p>Set the <code>CMAKE_&lt;LANG&gt;_COMPILER_LAUNCHER</code> variable or the <code>&lt;LANG&gt;_COMPILER_LAUNCHER</code> property on a target to use something like CCache to “wrap” the compilation of the target. Support for CCache has been expanding in the latest versions of CMake. </p>
<figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">find_program</span>(CCACHE_PROGRAM ccache)</span><br><span class="line"><span class="keyword">if</span>(CCACHE_PROGRAM)</span><br><span class="line">    <span class="keyword">set</span>(CMAKE_CXX_COMPILER_LAUNCHER <span class="string">"$&#123;CCACHE_PROGRAM&#125;"</span>)</span><br><span class="line">    <span class="keyword">set</span>(CMAKE_CUDA_COMPILER_LAUNCHER <span class="string">"$&#123;CCACHE_PROGRAM&#125;"</span>) <span class="comment"># CMake 3.9+</span></span><br><span class="line"><span class="keyword">endif</span>()</span><br></pre></td></tr></table></figure>
<h3 id="Interprocedural-optimization"><a href="#Interprocedural-optimization" class="headerlink" title="Interprocedural optimization"></a>Interprocedural optimization</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">include(CheckIPOSupported)</span><br><span class="line">check_ipo_supported(RESULT _IsIPOSupported)</span><br><span class="line">  if(_IsIPOSupported)</span><br><span class="line">  message(STATUS &quot;Turn on INTERPROCEDURAL_OPTIMIZATION&quot;)</span><br><span class="line">  set(CMAKE_INTERPROCEDURAL_OPTIMIZATION TRUE)</span><br><span class="line">  //set_target_properties(foo PROPERTIES INTERPROCEDURAL_OPTIMIZATION TRUE)</span><br><span class="line">endif()</span><br></pre></td></tr></table></figure>
<h2 id="Create-docs-with-doxygen"><a href="#Create-docs-with-doxygen" class="headerlink" title="Create docs with doxygen"></a>Create docs with doxygen</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">find_package(Doxygen REQUIRED)</span><br><span class="line"></span><br><span class="line">set(DOXYGEN_GENERATE_HTML YES)</span><br><span class="line">set(DOXYGEN_EXTRACT_ALL YES)</span><br><span class="line">set(DOXYGEN_BUILTIN_STL_SUPPORT YES)</span><br><span class="line"></span><br><span class="line">doxygen_add_docs(doxygen_docs &quot;$&#123;PROJECT_SOURCE_DIR&#125;/src&quot;)</span><br></pre></td></tr></table></figure>
<h2 id="Antipatterns-and-Patterns"><a href="#Antipatterns-and-Patterns" class="headerlink" title="Antipatterns and Patterns"></a>Antipatterns and Patterns</h2><h3 id="CMake-Antipatterns"><a href="#CMake-Antipatterns" class="headerlink" title="CMake Antipatterns"></a>CMake Antipatterns</h3><ul>
<li><strong>Do not use global functions</strong>: This includes <code>link_directories</code>, <code>include_libraries</code>, and similar.</li>
<li><strong>Don’t add unneeded PUBLIC requirements</strong>: You should avoid forcing something on users that is not required (<code>-Wall</code>). Make these PRIVATE instead.</li>
<li><strong>Don’t GLOB files</strong>: Make or another tool will not know if you add files without rerunning CMake. Note that CMake 3.12 adds a <code>CONFIGURE_DEPENDS</code> flag that makes this far better if you need to use it.</li>
<li><strong>Link to built files directly</strong>: Always link to targets if available.</li>
<li><strong>Never skip PUBLIC/PRIVATE when linking</strong>: This causes all future linking to be keyword-less.</li>
</ul>
<h3 id="CMake-Patterns"><a href="#CMake-Patterns" class="headerlink" title="CMake Patterns"></a>CMake Patterns</h3><ul>
<li><strong>Treat CMake as code</strong>: It is code. It should be as clean and readable as all other code.</li>
<li><strong>Think in targets</strong>: Your targets should represent concepts. Make an (IMPORTED) INTERFACE target for anything that should stay together and link to that.</li>
<li><strong>Export your interface</strong>: You should be able to run from build or install.</li>
<li><strong>Write a Config.cmake file</strong>: This is what a library author should do to support clients.</li>
<li><strong>Make ALIAS targets to keep usage consistent</strong>: Using <code>add_subdirectory</code> and <code>find_package</code> should provide the same targets and namespaces.</li>
<li><strong>Combine common functionality into clearly documented functions or macros</strong>: Functions are better usually.</li>
<li><strong>Use lowercase function names</strong>: CMake functions and macros can be called lower or upper case. Always use lower case. Upper case is for variables.</li>
<li><strong>Use <code>cmake_policy</code> and/or range of versions</strong>: Policies change for a reason. Only piecemeal set OLD policies if you have to.</li>
</ul>
<h1 id="More-Modern-CMake"><a href="#More-Modern-CMake" class="headerlink" title="More Modern CMake"></a>More Modern CMake</h1><h2 id="Use-target-sources-to-add-sources-and-header-files"><a href="#Use-target-sources-to-add-sources-and-header-files" class="headerlink" title="Use target_sources to add sources and header files"></a>Use target_sources to add sources and header files</h2><h3 id="Traditional-methods"><a href="#Traditional-methods" class="headerlink" title="Traditional methods"></a>Traditional methods</h3><p>Typically, developers define a target by listing the source files directly in the <code>add_executable()</code> or <code>add_library()</code> command itself. When the number of source files grows large and they get distributed over a number of subdirectories, possibly nested to multiple levels, this quickly becomes unwieldly. It also results in having to repeat the directory structure, which reduces the benefit of structuring source files into directories.</p>
<p>The logical improvement many developers then make is to build up the list of source files in a variable as each subdirectory is pulled in via <code>include()</code>. Then after all the subdirectories have been included, <code>add_executable()</code> or <code>add_library()</code> is called, but this time passing just the variable instead of an explicit list of files. The top level CMakeLists.txt file then looks something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># The name of the included file could be anything,</span><br><span class="line"># it doesn&apos;t have to be called CMakeLists.txt</span><br><span class="line">include(foo/CMakeLists.txt)</span><br><span class="line">include(bar/CMakeLists.txt)</span><br><span class="line"></span><br><span class="line">add_executable(myApp $&#123;myApp_SOURCES&#125;)</span><br></pre></td></tr></table></figure>
<p>with the subdirectory files structured something like this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list(APPEND myApp_SOURCES</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo.cpp</span><br><span class="line">    $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo_p.cpp</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>This allows each subdirectory to define just the sources it provides and to delegate any further nested subdirectories with another <code>include()</code>. It also keeps the top level CMakeLists.txt file quite small and the CMakeLists.txt in each subdirectory also tends to be reasonably uncomplicated and focussed just on the things in that directory.</p>
<p>As an alternative to explicitly building up a list of source files in a variable, some developers instead choose to let CMake find the source files and generate the contents of that variable automatically with the <code>file(GLOB_RECURSE ...)</code> command. But this technique has a number of drawbacks and is <a href="https://cmake.org/cmake/help/latest/command/file.html" target="_blank" rel="noopener">actively discouraged by the CMake documentation</a>. </p>
<h3 id="target-sources"><a href="#target-sources" class="headerlink" title="target_sources()"></a>target_sources()</h3><p>An example should help to highlight why <code>target_sources()</code> leads to much more robust and concise CMakeLists.txt files. </p>
<p>Let’s say we have a project with two subdirectories <code>foo</code> and <code>bar</code>. The top level CMakeLists.txt file can be as simple as this:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.13)</span><br><span class="line">project(MyProj)</span><br><span class="line"></span><br><span class="line">add_library(myLib &quot;&quot;)</span><br><span class="line"></span><br><span class="line">add_subdirectory(foo)</span><br><span class="line">add_subdirectory(bar)</span><br></pre></td></tr></table></figure>
<p>The CMakeLists.txt file within the <code>foo</code> subdirectory might then look something like this:</p>
<h4 id="CMake-3-13-0-or-later"><a href="#CMake-3-13-0-or-later" class="headerlink" title="CMake 3.13.0 or later"></a>CMake 3.13.0 or later</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">target_sources(myLib</span><br><span class="line">    PRIVATE</span><br><span class="line">        foo.cpp</span><br><span class="line">        foo_p.cpp</span><br><span class="line">        foo_p.h</span><br><span class="line">    PUBLIC</span><br><span class="line">        foo.h</span><br><span class="line">)</span><br><span class="line">find_library(BARRY_LIB barry)</span><br><span class="line"></span><br><span class="line"># This call requires CMake 3.13 or later</span><br><span class="line">target_link_libraries(myLib PUBLIC $&#123;BARRY_LIB&#125;)</span><br><span class="line"></span><br><span class="line">target_compile_definitions(myLib PUBLIC USE_BARRY)</span><br><span class="line">target_include_directories(myLib PUBLIC $&#123;CMAKE_CURRENT_LIST_DIR&#125;)</span><br></pre></td></tr></table></figure>
<h4 id="CMake-3-12-And-Earlier"><a href="#CMake-3-12-And-Earlier" class="headerlink" title="CMake 3.12 And Earlier"></a>CMake 3.12 And Earlier</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">target_sources(myLib</span><br><span class="line">    PRIVATE</span><br><span class="line">        $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo.cpp</span><br><span class="line">        $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo_p.cpp</span><br><span class="line">        $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo_p.h</span><br><span class="line">    PUBLIC</span><br><span class="line">        $&#123;CMAKE_CURRENT_LIST_DIR&#125;/foo.h</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>This is less convenient and less readable, so it may be helpful to define a helper function to give something close to the new behavior, but which also works for earlier CMake versions.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"># NOTE: This helper function assumes no generator expressions are used</span><br><span class="line">#       for the source files</span><br><span class="line">function(target_sources_local target)</span><br><span class="line">  if(POLICY CMP0076)</span><br><span class="line">    # New behavior is available, so just forward to it by ensuring</span><br><span class="line">    # that we have the policy set to request the new behavior, but</span><br><span class="line">    # don&apos;t change the policy setting for the calling scope</span><br><span class="line">    cmake_policy(PUSH)</span><br><span class="line">    cmake_policy(SET CMP0076 NEW)</span><br><span class="line">    target_sources($&#123;target&#125; $&#123;ARGN&#125;)</span><br><span class="line">    cmake_policy(POP)</span><br><span class="line">    return()</span><br><span class="line">  endif()</span><br><span class="line"></span><br><span class="line">  # Must be using CMake 3.12 or earlier, so simulate the new behavior</span><br><span class="line">  unset(_srcList)</span><br><span class="line">  get_target_property(_targetSourceDir $&#123;target&#125; SOURCE_DIR)</span><br><span class="line"></span><br><span class="line">  foreach(src $&#123;ARGN&#125;)</span><br><span class="line">    if(NOT src STREQUAL &quot;PRIVATE&quot; AND</span><br><span class="line">       NOT src STREQUAL &quot;PUBLIC&quot; AND</span><br><span class="line">       NOT src STREQUAL &quot;INTERFACE&quot; AND</span><br><span class="line">       NOT IS_ABSOLUTE &quot;$&#123;src&#125;&quot;)</span><br><span class="line">      # Relative path to source, prepend relative to where target was defined</span><br><span class="line">      file(RELATIVE_PATH src &quot;$&#123;_targetSourceDir&#125;&quot; &quot;$&#123;CMAKE_CURRENT_LIST_DIR&#125;/$&#123;src&#125;&quot;)</span><br><span class="line">    endif()</span><br><span class="line">    list(APPEND _srcList $&#123;src&#125;)</span><br><span class="line">  endforeach()</span><br><span class="line">  target_sources($&#123;target&#125; $&#123;_srcList&#125;)</span><br><span class="line">endfunction()</span><br></pre></td></tr></table></figure>
<p>Now we can call the above helper function just like the builtin command and get the CMake 3.13 behavior even with CMake 3.12 or earlier:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">target_sources_local(myLib</span><br><span class="line">    PRIVATE</span><br><span class="line">        foo.cpp</span><br><span class="line">        foo_p.cpp</span><br><span class="line">        foo_p.h</span><br><span class="line">    PUBLIC</span><br><span class="line">        foo.h</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>When using CMake 3.12 or earlier, working around the restriction with <code>target_link_libraries()</code> is harder. The choices are either to move the <code>target_link_libraries()</code> call up to the same directory in which the target is defined, or avoid creating new directory scopes by using <code>include()</code> instead of <code>add_subdirectory()</code>. The second of these options would only require changing the top level CMakeLists.txt file to something like the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.1)</span><br><span class="line">project(MyProj)</span><br><span class="line"></span><br><span class="line">add_library(myLib &quot;&quot;)</span><br><span class="line"></span><br><span class="line"># Using include() avoids creating a new directory scope, so these directories</span><br><span class="line"># are able to call target_link_libraries(myLib ...)</span><br><span class="line">include(foo/CMakeLists.txt)</span><br><span class="line">include(bar/CMakeLists.txt)</span><br></pre></td></tr></table></figure>
<p>The <code>target_sources_local()</code> helper function is defined in such a way that it will work inside <code>foo</code> or any other directory, regardless of whether we use <code>add_subdirectory()</code> or <code>include()</code>. </p>
<p>Specifying <code>PRIVATE</code> sources is relatively easy and has few difficulties. The location of each source file is clear and only needs to be considered within the build. Any <code>PUBLIC</code> or <code>INTERFACE</code> sources give rise to additional factors which must be considered. Within the build, paths to non-private sources are handled just like private ones, but when the project is installed, non-private paths have to make sense not only in the project’s own build, but also in the build of anything consuming the installed project. Projects should weigh up the loss of convenience and added complexity against the expected benefits to be gained by making sources non-private.</p>
<h2 id="Object-Libraries"><a href="#Object-Libraries" class="headerlink" title="Object Libraries"></a>Object Libraries</h2><p>Object Libraries carry <strong>usage-requirements</strong> (include-search-path (./headers), preprocessor-definition (IS_EXAMPLE=1)) and <strong>object files</strong>(generated from its private sources).</p>
<div style="width:100%;margin:auto"><img src="/2020/11/15/Practices/target_sources1.png"></div>

<div style="width:100%;margin:auto"><img src="/2020/11/15/Practices/target_sources2.png"></div>

<div style="width:100%;margin:auto"><img src="/2020/11/15/Practices/target_sources3.png"></div>

<h1 id="These-References-Are-Awesome"><a href="#These-References-Are-Awesome" class="headerlink" title="These References Are Awesome!"></a>These References Are Awesome!</h1><p>Most of the contents in this post are from the following posts. They’ve helped me out along the whole learning. Check them for more details!</p>
<p><a href="https://blog.xizhibei.me/tags/C-C/" target="_blank" rel="noopener">CMake 系列</a></p>
<p><a href="https://hedzr.github.io/categories/#cmake" target="_blank" rel="noopener">CMake Notes</a></p>
<p><a href="https://cliutils.gitlab.io/modern-cmake/" target="_blank" rel="noopener">Modern CMake</a></p>
<p><a href="https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1" target="_blank" rel="noopener">Effective Modern CMake</a></p>
<p><a href="https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/" target="_blank" rel="noopener">Pablo Atias, It’s Time To Do CMake Right, Feb 19, 2018</a></p>
<p><a href="https://crascit.com/2016/01/31/enhanced-source-file-handling-with-target_sources/" target="_blank" rel="noopener">Craig Scott, Enhanced source file handling with target_sources(), Jan 31, 2016</a></p>
<p><a href="https://www.youtube.com/watch?v=rLopVhns4Zs&amp;list=WL&amp;index=13&amp;t=2222s" target="_blank" rel="noopener">Daniel Pfeifer, “Effective CMake”, June 22, 2017</a></p>
<p><a href="https://www.youtube.com/watch?v=y9kSr5enrSk&amp;list=WL&amp;index=14&amp;t=3079s" target="_blank" rel="noopener">Oh No! More Modern CMake - Deniz Bahadir - Meeting C++ 2019</a></p>
<p><a href="http://www.steveire.com/embracing-modern-cmake.pdf" target="_blank" rel="noopener">Stephen Kelly, Embracing Modern CMake-How to recognize and use modern CMake Intercaces, Sept 11, 2017</a> </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/09/07/Cross-Compile/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/09/07/Cross-Compile/" itemprop="url">
                  💻 Compile FFMPEG For Raspberry Pi 4
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2020-09-07 20:56:48" itemprop="dateCreated datePublished" datetime="2020-09-07T20:56:48-07:00">2020-09-07</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-30 15:48:36" itemprop="dateModified" datetime="2020-12-30T15:48:36-08:00">2020-12-30</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>This post explains how to compile <a href="https://ffmpeg.org/" target="_blank" rel="noopener">FFMPEG</a> for Raspberry Pi 4 Target.</p>
<h1 id="Compile-directly-in-RPi4"><a href="#Compile-directly-in-RPi4" class="headerlink" title="Compile directly in RPi4"></a>Compile directly in RPi4</h1><p><a href="https://pimylifeup.com/compiling-ffmpeg-raspberry-pi/" target="_blank" rel="noopener">Compiling directly on RPi</a> is possible and straghtforward, but since RPi’s hardware is very limited, it might take a long time to complete the compiling process. This is an example of a basic version of ffmpeg.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clone git://source.ffmpeg.org/ffmpeg --depth=1</span><br><span class="line">cd ffmpeg</span><br><span class="line">./configure --arch=armel --target-os=linux</span><br><span class="line">make -j</span><br><span class="line">sudo make install</span><br></pre></td></tr></table></figure>
<h1 id="Cross-Compile-in-Ubuntu"><a href="#Cross-Compile-in-Ubuntu" class="headerlink" title="Cross Compile in Ubuntu"></a>Cross Compile in Ubuntu</h1><p>It’s recommended to use <a href="https://trac.ffmpeg.org/wiki/CompilationGuide/RaspberryPi" target="_blank" rel="noopener">cross-compilation</a>. we will need to set up the build environment in Ubuntu, install the related dependencies and finally install FFMPEG. </p>
<h2 id="Set-up-dev-environment"><a href="#Set-up-dev-environment" class="headerlink" title="Set up dev environment"></a>Set up dev environment</h2><p>Here is how I build the toolchain.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir ~/raspi</span><br><span class="line">mkdir ~/raspi/toolchain</span><br></pre></td></tr></table></figure>
<p>Then I download cross compiler from <a href="https://releases.linaro.org/components/toolchain/binaries/latest-7/arm-linux-gnueabihf/" target="_blank" rel="noopener">linaro</a>, including gcc, runtime and sysroot. Unzip them and combine them altogether under ~/raspi/toolchain.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:~/raspi/toolchain/bin</span><br><span class="line"><span class="built_in">export</span> CCPREFIX=<span class="string">"~/raspi/toolchain/bin/arm-linux-gnueabihf-"</span></span><br></pre></td></tr></table></figure>
<p>There are a lot of different tools for building cross-compilers.  Here are two other methods I’ve tried, which are both working pretty well too.</p>
<h3 id="Method-1"><a href="#Method-1" class="headerlink" title="Method 1"></a><a href="https://www.bootc.net/archives/2012/05/26/how-to-build-a-cross-compiler-for-your-raspberry-pi/" target="_blank" rel="noopener">Method 1</a></h3><p><a href="http://crosstool-ng.org/" target="_blank" rel="noopener">crosstool-ng</a> by far might be the quickest and easiest. </p>
<ol>
<li><p>Build the crosstool-ng</p>
<p>Download the latest version, cd to the unpacked directory and run the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/opt/cross</span><br><span class="line">make</span><br><span class="line">sudo make install</span><br><span class="line">export PATH=$PATH:/opt/cross/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>Build the toolchain</p>
<p>Create a directory that crosstool-ng will use as a staging ground. This directory will contain your toolchain configuration, downloaded files and intermediary build results.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir <span class="variable">$&#123;ctng_path&#125;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;ctng_path&#125;</span></span><br><span class="line">ct-ng menuconfig</span><br></pre></td></tr></table></figure>
<p>ct-ng configuration menu will show up.</p>
<p><strong>Paths and misc options</strong> </p>
<ul>
<li>Enable “Try features marked as EXPERIMENTAL”</li>
<li>Change “Prefix directory”, eg: “/opt/cross/x-tools/${CT_TARGET}”</li>
</ul>
<p><strong>Target options</strong></p>
<ul>
<li>Change “Target architecture” to “arm”</li>
<li>Leave “Endianness” set to “Little endian”</li>
<li>Leave “Bitness” set to “32-bit”</li>
</ul>
<p><strong>Operating system</strong> </p>
<ul>
<li>Change “Target OS” to “linux”</li>
</ul>
<p><strong>C Compiler</strong></p>
<ul>
<li>Enable “Show Linaro versions (EXPERIMENTAL)”. In the “gcc version” field, choose the “linaro-4.6-2012.04 (EXPERIMENTAL) compiler”</li>
<li>Enable “<em>C++</em>“ under the group “Additional supported languages” if you need g++ tool also built for your RPi toolchain</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ct-ng build</span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:/opt/cross/x-tools/arm-unknown-linux-gnueabi/bin</span><br><span class="line"><span class="built_in">export</span> CCPREFIX=<span class="string">"/opt/cross/x-tools/arm-unknown-linux-gnueabi/bin/arm-unknown-linux-gnueabi-"</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Method-2"><a href="#Method-2" class="headerlink" title="Method 2"></a>Method 2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/raspberrypi/tools.git</span><br><span class="line"><span class="built_in">cd</span> tools</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># for ubuntu Ubuntu 16.04 (64 bits)</span></span><br><span class="line"><span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$HOME</span>/raspberry/tools/arm-bcm2708/arm-rpi-4.9.3-linux-gnueabihf/bin</span><br><span class="line"><span class="built_in">export</span> CCPREFIX=<span class="string">"/opt/cross/x-tools/arm-unknown-linux-gnueabi/bin/arm-unknown-linux-gnueabi-"</span></span><br></pre></td></tr></table></figure>
<p>Check the following:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">arm-linux-gnueabihf-gcc --version</span><br></pre></td></tr></table></figure>
<h2 id="Install-dependencies"><a href="#Install-dependencies" class="headerlink" title="Install dependencies"></a>Install dependencies</h2><p>Some packages usually being used will be libaacplus, libx264, ALSA, etc. We will need to install them one by one. Before we can install these dependencies, we would have to get sysroot set to create a similar environment as RPi, where we could link to while cross-compiling. </p>
<p>The method I am using is mostly inspired by <a href="https://zhuanlan.zhihu.com/p/138021025" target="_blank" rel="noopener">this</a>.</p>
<p>Firstly, copy /usr, /lib, /opt/vc from RPi to your PC.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/raspi</span><br><span class="line">rsync -avz pi@<span class="variable">$&#123;ur_pi_address&#125;</span>:/lib sysroot</span><br><span class="line">rsync -avz pi@<span class="variable">$&#123;ur_pi_address&#125;</span>:/usr/include sysroot/usr</span><br><span class="line">rsync -avz pi@<span class="variable">$&#123;ur_pi_address&#125;</span>:/usr/lib sysroot/usr</span><br><span class="line">rsync -avz pi@<span class="variable">$&#123;ur_pi_address&#125;</span>:/opt/vc sysroot/opt</span><br></pre></td></tr></table></figure>
<p>The issue here is that most soft links in sysroot are absolute, which may link to your PC’s /usr, /lib, etc. To make them to point to sysroot, we need to modify the absolute paths to relative paths.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cd ~/raspi</span><br><span class="line">wget https://raw.githubusercontent.com/riscv/riscv-poky/master/scripts/sysroot-relativelinks.py</span><br><span class="line">chmod +x sysroot-relativelinks.py</span><br><span class="line">./sysroot-relativelinks.py sysroot</span><br></pre></td></tr></table></figure>
<p>Besides this, another way is to pre-install some related libs in RPi and then mount SD card of RPi to the laptop(<a href="https://yjdwbj.github.io/2016/07/07/%E4%B8%BA%E6%A0%91%E8%8E%93%E6%B4%BE%E4%BA%A4%E5%8F%89%E7%BC%96%E8%AF%91FFMPEG%E7%A8%8B%E5%BA%8F/" target="_blank" rel="noopener">Reference</a>).</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libssl1.0-dev libbz2-1.0 libmbedcrypto3 libmbedtls-dev nettle-dev libbz2-dev</span><br></pre></td></tr></table></figure>
<p>Same here, you will also need to solve the soft link issue, here is the solution: <a href="https://raspberrypi.stackexchange.com/questions/79226/cross-compiling-with-nfs-mount-as-sysroot-fails-due-to-absolute-links" target="_blank" rel="noopener">Cross-compiling with nfs-mount as sysroot fails due to absolute links</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~$ cat symlinks.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">cd $&#123;_SYSROOT_PATH&#125;/arm-linux-gnueabihf</span><br><span class="line">for L in $(find -type l)</span><br><span class="line">do</span><br><span class="line">    ABS=$(readlink $L)</span><br><span class="line">    if [[ $ABS =~ ^/ ]]</span><br><span class="line">    then</span><br><span class="line">    # before : /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; /lib/arm-linux-gnueabihf/libanl.so.1</span><br><span class="line">    # after :  /usr/lib/arm-linux-gnueabihf/libanl.so -&gt; ../../../lib/arm-linux-gnueabihf/libanl.so.1</span><br><span class="line">        RELPATH=$(realpath --relative-to=$L -s ../../$ABS)</span><br><span class="line">        echo fixing link of $L to $ABS with $RELPATH</span><br><span class="line">        sudo ln -svf $RELPATH $L</span><br><span class="line">    fi</span><br><span class="line">done</span><br></pre></td></tr></table></figure>
<p>Now we can install dependencies. Here is an example to install opus. You can install others following the same way.</p>
<h3 id="Opus"><a href="#Opus" class="headerlink" title="Opus"></a>Opus</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/xiph/opus.git</span><br><span class="line"><span class="built_in">cd</span> opus &amp;&amp; ./autogen.sh &amp;&amp; mkdir build-rpi &amp;&amp; <span class="built_in">cd</span> build-rpi</span><br><span class="line">cmake -DCMAKE_TOOLCHAIN_FILE=<span class="string">"<span class="variable">$&#123;CMAKE_FILE_PATH&#125;</span>"</span> -DCMAKE_INSTALL_PREFIX=<span class="string">"~/raspi/sysroot/usr/local"</span> -DOPUS_BUILD_SHARED_LIBRARY=ON ..</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>CMAKE_FILE_PATH file example:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">SET(CMAKE_SYSTEM_NAME Linux)</span><br><span class="line">SET(CMAKE_SYSTEM_VERSION 1)</span><br><span class="line">SET(CMAKE_C_COMPILER ~/raspi/toolchain/bin/arm-linux-gnueabihf-gcc)</span><br><span class="line">SET(CMAKE_CXX_COMPILER ~/raspi/toolchain/bin/arm-linux-gnueabihf-g++)</span><br><span class="line">SET(CMAKE_FIND_ROOT_PATH ~/raspi/sysroot)</span><br><span class="line">SET(ENV&#123;PKG_CONFIG_LIBDIR&#125; <span class="string">"~/raspi/sysroot/usr/local/lib/pkgconfig"</span>)</span><br><span class="line">SET(ENV&#123;PKG_CONFIG_SYSROOT_DIR&#125; <span class="string">"~/raspi/sysroot"</span>)</span><br><span class="line">SET(CMAKE_EXE_LINKER_FLAGS_INIT</span><br><span class="line">        <span class="string">"-Wl,-rpath-link -Wl,~/raspi/sysroot/usr/local/lib:~/raspi/sysroot/lib/rm-linux-gnueabihf:~/raspi/sysroot/usr/lib/rm-linux-gnueabihf"</span>)</span><br><span class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)</span><br><span class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)</span><br><span class="line">SET(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)</span><br></pre></td></tr></table></figure></p>
<h2 id="Install-FFMPEG"><a href="#Install-FFMPEG" class="headerlink" title="Install FFMPEG"></a>Install FFMPEG</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/FFmpeg/FFmpeg.git</span><br><span class="line"><span class="built_in">cd</span> FFmpeg &amp;&amp; \</span><br><span class="line"><span class="built_in">export</span> PKG_CONFIG_PATH=~/raspi/sysroot/usr/<span class="built_in">local</span>/lib/pkgconfig</span><br><span class="line">./configure \</span><br><span class="line">--<span class="built_in">enable</span>-cross-compile \</span><br><span class="line">--cross-prefix=<span class="string">"<span class="variable">$&#123;CCPREFIX&#125;</span>"</span></span><br><span class="line">--arch=armhf \</span><br><span class="line">--target-os=linux \</span><br><span class="line">--sysroot=<span class="string">"~/raspi/sysroot"</span> \</span><br><span class="line">--prefix=<span class="string">"~/raspi/sysroot/usr/local"</span> \</span><br><span class="line">--pkg-config=<span class="string">"pkg-config"</span> \</span><br><span class="line"><span class="comment">#disable and enable what you want here</span></span><br><span class="line">--<span class="built_in">disable</span>-... \</span><br><span class="line">--<span class="built_in">enable</span>-.... \</span><br><span class="line">--extra-cflags=<span class="string">"-I~/raspi/sysroot/usr/local/include"</span> \</span><br><span class="line">--extra-ldflags=<span class="string">"-Wl,-rpath-link,~/raspi/sysroot/usr/local/lib -Wl,-rpath,~/raspi/sysroot/usr/local/lib -L~/raspi/sysroot/usr/local/lib -lm -lopus"</span> \</span><br><span class="line">--extra-libs=<span class="string">"-lm -lopus"</span> --<span class="built_in">enable</span>-rpath</span><br><span class="line">make -j `nproc` &amp;&amp; sudo make install</span><br></pre></td></tr></table></figure>
<p>Note:</p>
<ol>
<li><p><code>-rpath-link</code> is used to find shared libraries required by other shared libraries at link time, <code>-rpath</code> is used to find the libraries at run time. This is required because the userland libraries are in a nonstandard location, <code>ld</code> will not search in <code>/opt/vc/lib</code> by default.</p>
</li>
<li><p>“–pkg-config=pkg-config” is required. This will override ffmpeg’s ./configure assumption that pkg-config is prefixed by the architecture. (e.g. aarch64-unknown-linux-gnu-pkg-config). Otherwise ffmpeg can not find opus.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">require_pkg_config libopus opus opus_multistream.h opus_multistream_decoder_create</span><br><span class="line">check_pkg_config libopus opus opus_multistream.h opus_multistream_decoder_create</span><br><span class="line">test_pkg_config libopus opus opus_multistream.h opus_multistream_decoder_create</span><br><span class="line">false --exists --print-errors opus</span><br><span class="line">ERROR: opus not found using pkg-config</span><br></pre></td></tr></table></figure>
</li>
</ol>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/25/2019/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/12/25/2019/" itemprop="url">
                  📖 Books of 2019
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-12-25 10:43:18" itemprop="dateCreated datePublished" datetime="2019-12-25T10:43:18-08:00">2019-12-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-16 16:26:23" itemprop="dateModified" datetime="2020-12-16T16:26:23-08:00">2020-12-16</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>✨<strong>The Bell Jar: Sylvia Plath</strong><br>✨<strong>Surely you are joking: Richard Feynman</strong><br>✨<strong>Becoming: Michelle Obama</strong><br>✨<strong>邓小平时代: 傅高义🌟🌟🌟🌟🌟</strong><br>✨<strong>激荡三十年（中国企业1978-2008）: 吴晓波🌟🌟🌟🌟🌟</strong><br>✨<strong>历代经济变革得失: 吴晓波</strong><br>✨<strong>Bad blood: John Carreyrou</strong><br>✨<strong>古巴本土可行的社会主义: 毛相麟</strong><br>✨<strong>简读中国史 张宏杰🌟🌟🌟</strong><br>✨<strong>长日将近 石黑一雄</strong><br>✨<strong>人类简史 尤瓦尔·赫拉利🌟🌟🌟🌟🌟</strong><br>✨<strong>忧郁的热带 列维·斯特劳斯</strong><br>✨<strong>Fame and Obscurity Gay Talese</strong><br>✨<strong>银河帝国 阿西莫夫🌟🌟🌟🌟🌟</strong><br>✨<strong>西方哲学简史 罗素</strong><br>✨<strong>协和百年</strong><br>✨<strong>幻夜 东野圭吾</strong><br>✨<strong>李光耀谈治国管理和人生</strong></p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/03/Projects/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/03/Projects/" itemprop="url">
                  📃 Projects
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-03-03 14:57:30" itemprop="dateCreated datePublished" datetime="2019-03-03T14:57:30-08:00">2019-03-03</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-31 11:47:05" itemprop="dateModified" datetime="2020-12-31T11:47:05-08:00">2020-12-31</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <ul>
<li><strong>Software Development✨</strong><details><summary>Media Player, 2020</summary><br></details><details><summary>Ontologies Similarity Search based Matchmaking tool, 2019</summary><br><p> Designed a matchmaking tool that automated hiring processes of DS3 using ontology based similarity search.<br>Implemented the tool which helped suggest employees to work on a submitted project, highlight shortage of skills to satisfy project requirements, identify potential candidates for hiring, etc.</p><br></details></li>
<li><strong>Deep Learning✨</strong><details><summary><a href="https://github.com/670973787/DS-GA-1008-deep-learning" target="_blank" rel="noopener">Semi-supervised Vehicle Surroundings Detection, 2020</a></summary><br><p> Generated a top down view of the surrounding area using images from six views.<br>Proposed a variational auto-encoder network to predict the road map layout.<br>Built three models on top of Yolo-V1, GAN and U-Net separately to detect objects around.</p><br></details><details><summary><a href="https://github.com/sherlynchan/ECM_NLU" target="_blank" rel="noopener">Emotional Chatting Machine, 2019</a></summary><br><p> Used a pre-trained Bi-LSTM emotion classifier for automatic annotation on Twitter Dialogue dataset.<br>Implemented a RNN encoder-decoder and incorporated the emotion vector into the model.<br>Adopted an internal memory module and external memory module to control the output words in different<br>emotional categories.</p><br></details><details><summary>NLP Meta Learner, 2019</summary><br><p> Built a Model-Agnostic Meta-Learning based model for low resource Natural Language Understanding Tasks in Finance.</p><br></details><details><summary><a href="https://github.com/sherlynchan/Talk-like-Peppa-Pig" target="_blank" rel="noopener">Deep Voice Conversion, 2018</a></summary><br><p> Classified spectrogram to phonemes at every timestep of TIMIT dataset using Bidirectional LSTM model.<br>Converted the phonemes to magnitudes using Arctic dataset based on Bidirectional GRU model.<br>Reverted wav from spectrogram using Griffin-Lim reconstruction.</p><br></details></li>
<li><strong>Music✨</strong><details><summary><a href="https://github.com/sherlynchan/What-is-Next-Hip-Hop-Hit" target="_blank" rel="noopener">What’s Next Hit Rap Song, 2018</a></summary><br><p> Scrapped the latest five-year rap tracks’ audio features, lyrics, etc. from Billboard, Genius and Spotify.<br>Performed Topic Modeling using LDA and implemented Sentiment Analysis on lyrics. Built a Logistic Regression classifier to make classification with an accuracy of 82.33%.<br>Designed a web interface demo with Django framework.</p><br></details></li>
<li><strong>Finance✨</strong><details><br><summary>Public Fund Product Portrait, 2018</summary><br><p> Factor Construction: created a product portrait of public funds in China Market, integrated public fund historical data from various resources, implemented the calculations of fundamental indicators, technical indicators and return-risk indicators and updated the database daily.<br>Single Factor Analysis: measured the return rate predictive skills of indicators based on IC.<br>Built a Flask-based web demo for product development and testing.</p><br></details><details><br><summary>Development of Guangdong Science &amp; Technology Insurance, 2016</summary><br><p> Analyzed the evolution of government’s role in the development of Science and Technology Insurance based on Game Theory.<br>Evaluated Guangdong’s current policy using the Entropy Weight and Synthesis Evaluation Model and Cluster Analysis.<br>Designed an overall implementation scheme for the development of Guangdong Science and Technology Insurance.</p><br></details></li>
<li><strong>Brain Science✨</strong><details><summary>Visual Area Auto-labeling, 2020</summary><br></details><details><summary><a href="https://github.com/sherlynchan/EEG-Based-Person-Authentication" target="_blank" rel="noopener">EEG Based Person Authentication System Using a Self-paced Reaching Task, 2017</a></summary><br><p> Designed a self-paced reaching task and implemented the experiment interface, collected EEG data of 30 subjects using a BrainAmp DC amplifier with 64 active Ag/AgCl EEG electrodes.<br>Extracted 2 sets of features from 9 electrodes: 6th order autoregressive coefficients, power spectral density in 5 frequency bands.<br>Built a single-trial EEG based Person Authentication System based on a SVM classifier, with a highest accuracy rate of more than 97%.</p><br></details><details><br><summary><a href="https://github.com/sherlynchan/Attention-Monitoring-and-Alarming-for-Live-Education" target="_blank" rel="noopener">Attention-Monitoring-and-Alarming-for-Live-Education, 2017</a></summary><br><p> Decided the attention and meditation EEG threshold of each of 40 subjects in the states of concentration and distraction separately and recorded their attention status using MindWave while they were watching a video.<br>Used PC camera to record subjects’ image and performed face recognition based on the trained Haar Classifier, and the ASM algorithm was used for eye tracking to determine the subjects’ distraction status with the accuracy rate of 87%.<br>Explored internal and external influential factors on human attention based on Hypothesis Testing.</p><br></details></li>
<li><strong>Healthcare✨</strong><details><br><summary>A Wearable Health Status Monitoring Device, 2016</summary><br><p> Used Arduino and Sensors to make a wearable device, which collected people’s pulse signals and transferred the pulse data to the cloud via Bluetooth.<br>Investigated the pulse data of 100 subjects having different living habits at NCTU<br>Analyzed people’s health status using Multi-scale Entropy Method based on the pulse data collected.</p><br></details></li>
<li><strong>User Behavior✨</strong><details><br><summary><a href="https://github.com/sherlynchan/People-s-Television-Viewing-Behavior-Analysis" target="_blank" rel="noopener">People’s Television Viewing Behavior Analysis, 2015</a></summary><br><p> Cleaned a set of data from China’s television market, produced the data visualization, and studied users’ viewing preference using Association Rules; predicted users’ viewing behavior based on the Markov Model and Bayesian Theory, etc.</p><br></details>
</li>
</ul>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/25/Books-2018/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/25/Books-2018/" itemprop="url">
                  📖 Books of 2018
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-12-25 18:05:05" itemprop="dateCreated datePublished" datetime="2018-12-25T18:05:05-08:00">2018-12-25</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-16 16:23:40" itemprop="dateModified" datetime="2020-12-16T16:23:40-08:00">2020-12-16</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>✨<strong>No Longer Human (Osamu Dazai)</strong></p>
<p>世界上有的人就是不能理所应当地活着 无法和人类整体哪怕一点一致</p><br>✨<strong>Neapolitan Novels (Elena Ferrante)</strong><br><p>My Brilliant Friend, The Story of a New Name, Those Who Leave And Those Who Stay, and The Story of the Lost Child</p><br><p>final间刷了四本 虽然不喜欢蒂娜的内心戏 但同样大环境下的两种命运也有感触到 就像那些小时候我身边的女孩后来都消失了 你知道什么是庶民吗？我们就是庶民，庶民就是争抢食物和酒，就是为了上菜的先后次序、服务好坏而争吵，就是那面肮脏的地板，就是那些越来越粗俗的祝酒词。</p><br>✨<strong>thus spoke zarathustra (nietzsche)</strong><br><p>如果你不相信上帝也不相信生命的意义要怎么自洽怎么建立自己的体系 </p><br>✨<strong>speak memory(nabokov)</strong><br><p>albert说这是他读过最好的一本自传 繁复华丽的句子太美 这是写洛丽塔的人阿 </p><br>✨<strong>纽约客 (白先勇)</strong><br><p>这些文字写的纽约堕落辉煌 最喜欢tea for two soooooo cute</p><br>✨<strong>The Second Sex (Simone de Beauvoir)</strong><br><p>非女权主义者 看这本源于对萨特和伏的开放关系好奇 女性在这个世界的现在 究竟是基因还是历史决定的 很长的一段时间里我对性别的纠结无法协调 地理独立生活的九年 精神独立生活的时间更长 沿着书重新思考自己的环境家庭社会和自我教育 逐渐找到身份认同和与自己的相处方式 </p><br>✨ <strong>Stoner (John Williams)</strong><br><p>“即使不能拥有完美的生活 所幸追求过完整的自我” 那些他深信不疑的事物对他背叛的最彻底 一个人得准备好为自己的信念忍受痛苦</p><br>✨<strong>笑场 (李诞)</strong><br><p>诞诞的书 扯经最爱 后面的小诗每次坐地铁都读一读 </p><br>✨<strong>人间采蜜记 (李银河)</strong><br><p>李银河的自传 她拥有自己 也拥有自由</p><br>✨<strong>Ethnic America (Thomas Sowell)</strong><br><p>美国各个种族的性格 历史 文化和成就 </p><br>✨<strong>宇宙超度指南 (李诞)</strong><br><p>看十三幺后看的这本 有的人为别人而活  有的人为别人而死 一瓶酒如果不喝 始终不是一瓶酒</p><br>✨<strong>When Nietzsche Wept (Irvin D. Yalom)</strong><br><p>看梗概都心动的书 身陷对病人肉欲幻想无法自拔的名医布雷尔在路·莎乐美的引诱下试图治疗不愿接受帮助的尼采的“绝望”却面临自己的“绝望”  火速看完书并补了电影btw私心觉得电影里的不是心中的莎乐美</p><br>✨<strong>Little Fires Everywhere (Celeste Ng)</strong><br><p>你要记得你呼吸的每一个瞬间都应该去过你想要的生活</p><br>✨<strong>In Praise of Shadows (Jun’ichirō Tanizaki)</strong><br><p>东方美学 阴翳 模糊 暧昧 幽暗 礼赞不起眼场景中至美 以及 这个人太妙了 </p><br>✨<strong>The Stranger (Albert Camus)</strong><br><p>抛开法律机器对人性精神道德的残杀这部分 很对莫索尔极端虚无感能identify </p><br>✨<strong>Twelve Tomorrows</strong><br><p>因为大刘的黄金原野看的讲的是VR 刘宇昆的拜占庭同情也非常不错</p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/31/Love and Knowledge/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="ShaolingC">
      <meta itemprop="description" content="✨✨✨">
      <meta itemprop="image" content="/images/yoda-hiding.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Afterwork">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/31/Love and Knowledge/" itemprop="url">
                  📒 Love and Knowledge
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2018-08-31 16:19:51" itemprop="dateCreated datePublished" datetime="2018-08-31T16:19:51-07:00">2018-08-31</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">Edited on</span>
                
                <time title="Modified: 2020-12-16 16:23:16" itemprop="dateModified" datetime="2020-12-16T16:23:16-08:00">2020-12-16</time>
              
            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>I have found that when people act out of love, the effect can be powerful. However, when that love is combined with knowledge, the effect is much more powerful because it is informed and rational. This is what I have learned through in-depth participation in philanthropy and volunteer work, having deepened my thinking about love and knowledge, which are the basis of my personal creed.</p>
<p>When I was in middle school, I began to do extensive volunteer work. Being educated to love and help others, I have launched a fundraising campaign independently for a child with a severe hearing loss who could not afford the high cost of surgery, organized a BikeForCharity activity to help homeless people, and built a Wechat Official Accounts Platform to help raise money for a rural primary school in China to build a playground, among other activities. </p>
<p>In 2014, realizing the tiny power of one person and with a goal to influence more young people to take action in our community, I became an intern in an NGO, whose mission was to accompany and support youth to create positive changes. There, I was not only more involved in public welfare projects but also had more opportunities to make contact with other NGOs. </p>
<p>However, as time passed, I noticed some common problems of grassroot organizations in China. Without accurate positioning, systematic management, and fund-raising ability, most NGOs lacked long-term operation capability and thus could not develop sustainably. To change the status quo, I joined a global social innovation enterprise, in 2015. Being a consultant, I tried to adopt approaches of Management Consulting to help these organizations analyze and resolve their difficulties. It was the first time I viewed philanthropy from the perspective of third-party observer, and I clearly realized that it was not enough to engage merely with love and passion. Love and knowledge are inextricably bound together. Only when you act with professional knowledge can you realize smart, efficient outcomes and thus benefit more people. </p>
<p>Love is blind, but love can be rational. Love endows knowledge with meaning and knowledge protects love; I seek the point of their great intersection.</p>
<p>In the spring of 2016, I volunteered at a mental hospital where I had my first contact with patients suffering from mental health disorders. I was initially fearful, but I happened to read a book called The Man Who Mistook His Wife for a Hat in which Oliver Sacks described twenty-four stories of individuals afflicted with fantastic perceptual and intellectual aberrations, and that alleviated my fear. Through his humane and loving narration, I strongly felt the suffering and struggles of people with mental deficits but also caught a glimpse of the world of the neurologically impaired. How could all our memories, thoughts, dreams, and behaviors arise from a human brain that weighs just three pounds? In what way and why are those patients different from us? What can we do to make them feel better? Not content with just reading popular science materials, I determined to look for the answer personally. That’s when I began to study neuroscience. </p>
<p>Later, after completing several independent projects in neural data I determined to follow the path of academic research in neuroscience in the future. Now I am pursuing a master degree in data science because the newest experimental measurement methods have brought us massive neural data, which we never had access to before, and for which we greatly need advanced data analysis methods. I wish to understand more about the human brain and help more people through my work in neuroscience, which will be the practice of my belief in the positive union of love and knowledge.</p>
<p>“For the wisdom of human life, and the wisdom of the whole world.” A lama told me these words when I travelled alone to Nepal, living in Lumbini, to ask the meaning of life at the age of eighteen. Although I was never a Buddhist, these words have been with me until now. I suppose I found it finally. I never forgot the night I left that small temple. The sky was deeply dark, but stars were brightly shining. They were beautiful and watching me.  </p>

          
        
      
    </div>

    

    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/yoda-hiding.png"
                alt="ShaolingC" />
            
              <p class="site-author-name" itemprop="name">ShaolingC</p>
              <p class="site-description motion-element" itemprop="description">✨✨✨</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">8</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">4</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  <a href="https://github.com/Sherlynchan" target="_blank" title="GitHub"><i class="fa fa-fw fa-github"></i>GitHub</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="mailto:sc6995@nyu.edu" target="_blank" title="E-Mail"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.linkedin.com/in/shaoling-chen-420591b2/" target="_blank" title="LinkedIn"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a>
                  
                </span>
              
                <span class="links-of-author-item">
                  <a href="https://www.instagram.com/cinnamon_bear_and_/" target="_blank" title="Instagram"><i class="fa fa-fw fa-instagram"></i>Instagram</a>
                  
                </span>
              
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ShaolingC</span>

  

  
</div>




  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> v3.7.1</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a class="theme-link" target="_blank" href="https://theme-next.org">NexT.Gemini</a> v6.4.0</div>





    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>

    <span id="busuanzi_container_site_uv"> Total  <span id="busuanzi_value_site_uv"></span>  Visitors  </span>



        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.4.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.4.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.4.0"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.4.0"></script>



  



  










  





  

  

  

  

  
  

  

  

  

  

  

</body>
</html>
